<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Dashboard Integrated</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* 基本設定 */
  body { font-family: 'Arial', sans-serif; margin: 0; background: #f4f6f8; color: #333; }
  
  /* ヘッダー・ナビゲーション */
  header { display: flex; justify-content: center; gap: 15px; background: #1e1e2f; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  header button { background: #3b3b5f; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-size: 16px; transition: 0.3s; font-weight: bold; }
  header button:hover { background: #5c5c8f; transform: translateY(-2px); }
  header button.active { background: #ff6f61; box-shadow: 0 0 10px rgba(255,111,97,0.5); }

  /* セクション制御 */
  .section { display: none; padding: 20px; max-width: 1000px; margin: 0 auto; animation: fadeIn 0.5s; }
  .section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* グラフカード */
  .card { margin: 20px 0; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .card h3 { margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; color: #1e1e2f; }
  .chart-container { position: relative; height: 300px; width: 100%; }

  /* マップ */
  #map-container { height: 600px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  #map { width: 100%; height: 100%; border-radius: 8px; }

  /* データテーブル */
  #table-container { background: white; border-radius: 12px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; min-width: 600px; }
  th, td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
  th { background: #3b3b5f; color: white; white-space: nowrap; }
  tr:nth-child(even) { background: #f9f9f9; }
  tr:hover { background: #f1f1f1; }
</style>
</head>
<body>

<header>
  <button id="btn-graphs" class="active">グラフ表示</button>
  <button id="btn-map">GPSマップ表示</button>
  <button id="btn-table">受信ログ</button>
</header>

<div id="graph-section" class="section active">
  <div class="card">
    <h3>Panel Data (Solar)</h3>
    <div class="chart-container"><canvas id="chart-panel"></canvas></div>
  </div>
  <div class="card">
    <h3>Battery Data</h3>
    <div class="chart-container"><canvas id="chart-batt"></canvas></div>
  </div>
  <div class="card">
    <h3>Load Data</h3>
    <div class="chart-container"><canvas id="chart-load"></canvas></div>
  </div>
</div>

<div id="map-section" class="section">
  <div id="map-container">
    <div id="map"></div>
  </div>
</div>

<div id="table-section" class="section">
  <div id="table-container">
    <table id="data-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Panel V</th><th>Panel I</th><th>Panel P</th>
          <th>Batt V</th><th>Batt I</th><th>Batt P</th>
          <th>Load V</th><th>Load I</th><th>Load P</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
// ==========================================
// 1. Firebase 初期化 (➁の設定を使用)
// ==========================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616",
  storageBucket: "dronesgps-f3616.firebasestorage.app",
  messagingSenderId: "1068524436957",
  appId: "1:1068524436957:web:dbd9ec480ced3065314a34",
  measurementId: "G-STNDL06MJT"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ==========================================
// 2. UI切り替えロジック (➀のUI + マップ修正)
// ==========================================
const sections = {
  graphs: document.getElementById('graph-section'),
  map: document.getElementById('map-section'),
  table: document.getElementById('table-section')
};
const buttons = {
  graphs: document.getElementById('btn-graphs'),
  map: document.getElementById('btn-map'),
  table: document.getElementById('btn-table')
};

function showSection(name) {
  // すべて非表示・非アクティブ化
  Object.values(sections).forEach(el => el.classList.remove('active'));
  Object.values(buttons).forEach(el => el.classList.remove('active'));
  
  // 対象を表示・アクティブ化
  sections[name].classList.add('active');
  buttons[name].classList.add('active');

  // ★重要★ マップタブが開かれたら、Leafletのサイズを再計算する
  if (name === 'map') {
    setTimeout(() => {
      map.invalidateSize();
    }, 200); // アニメーション終了を少し待つ
  }
}

// ボタンにイベントリスナー設定
buttons.graphs.onclick = () => showSection('graphs');
buttons.map.onclick = () => showSection('map');
buttons.table.onclick = () => showSection('table');

// ==========================================
// 3. マップ初期化 (Leaflet)
// ==========================================
const map = L.map("map").setView([35.0, 135.0], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

let marker = null;

// ==========================================
// 4. グラフ初期化 (Chart.js)
// ==========================================
const MAX_POINTS = 50; // グラフに表示する最大ポイント数

function createChartConfig(title) {
  return {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Voltage (V)', data: [], borderColor: '#ff6384', backgroundColor: '#ff6384', yAxisID: 'y' },
        { label: 'Current (I)', data: [], borderColor: '#36a2eb', backgroundColor: '#36a2eb', yAxisID: 'y' },
        { label: 'Power (W)',   data: [], borderColor: '#4bc0c0', backgroundColor: '#4bc0c0', yAxisID: 'y1', borderDash: [5, 5] }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false, // パフォーマンス向上のためアニメーションOFF
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top' },
        title: { display: false, text: title }
      },
      scales: {
        x: { display: false }, // X軸ラベル（時刻）は混み合うので非表示
        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'V / I' } },
        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Watts' }, grid: { drawOnChartArea: false } }
      }
    }
  };
}

const chartPanel = new Chart(document.getElementById('chart-panel'), createChartConfig('Panel'));
const chartBatt = new Chart(document.getElementById('chart-batt'), createChartConfig('Battery'));
const chartLoad = new Chart(document.getElementById('chart-load'), createChartConfig('Load'));

// グラフ更新ヘルパー関数
function updateChart(chart, label, v, i, p) {
  chart.data.labels.push(label);
  chart.data.datasets[0].data.push(v);
  chart.data.datasets[1].data.push(i);
  chart.data.datasets[2].data.push(p);

  if (chart.data.labels.length > MAX_POINTS) {
    chart.data.labels.shift();
    chart.data.datasets.forEach(d => d.data.shift());
  }
  chart.update();
}

// ==========================================
// 5. データ受信 & 更新処理 (➁のロジック統合)
// ==========================================
const latestRef = ref(db, "latest");
const tableBody = document.querySelector('#data-table tbody');

onValue(latestRef, (snapshot) => {
  const data = snapshot.val();
  if (!data) return;

  const now = new Date().toLocaleTimeString();

  // --- 値の取得 (未定義の場合は0) ---
  const pv = data.panel?.voltage ?? 0;
  const pi = data.panel?.current ?? 0;
  const pp = data.panel?.power ?? 0;

  const bv = data.battery?.voltage ?? 0;
  const bi = data.battery?.current ?? 0;
  const bp = data.battery?.power ?? 0;

  const lv = data.load?.voltage ?? 0;
  const li = data.load?.current ?? 0;
  const lp = data.load?.power ?? 0;

  // --- 1. グラフ更新 ---
  updateChart(chartPanel, now, pv, pi, pp);
  updateChart(chartBatt, now, bv, bi, bp);
  updateChart(chartLoad, now, lv, li, lp);

  // --- 2. マップ更新 ---
  if (data.GPS?.lat && data.GPS?.lng) {
    const lat = data.GPS.lat;
    const lng = data.GPS.lng;
    const popupContent = `
      <b>Drone Position</b><br>
      Lat: ${lat.toFixed(5)}<br>
      Lng: ${lng.toFixed(5)}<br>
      Panel P: ${pp} W
    `;

    if (!marker) {
      marker = L.marker([lat, lng]).addTo(map);
      marker.bindPopup(popupContent).openPopup();
    } else {
      marker.setLatLng([lat, lng]);
      marker.setPopupContent(popupContent);
    }
    // 地図の中心をドローンに合わせる（追従）
    map.panTo([lat, lng]);
  }

  // --- 3. テーブルログ追加 (最新を一番上に) ---
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${now}</td>
    <td>${pv}</td><td>${pi}</td><td>${pp}</td>
    <td>${bv}</td><td>${bi}</td><td>${bp}</td>
    <td>${lv}</td><td>${li}</td><td>${lp}</td>
  `;
  tableBody.insertBefore(row, tableBody.firstChild);

  // 行が増えすぎないように制御 (例: 100行まで)
  if (tableBody.children.length > 100) {
    tableBody.removeChild(tableBody.lastChild);
  }
});

</script>
</body>
</html>
