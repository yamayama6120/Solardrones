<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Power Monitor V6</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f0f2f5; color: #333; }
  header { display: flex; justify-content: center; gap: 15px; background: #1a1a2e; padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
  header button.main-nav { background: #16213e; color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.3s; }
  header button.main-nav.active { background: #e94560; box-shadow: 0 0 15px rgba(233, 69, 96, 0.4); }

  .section { display: none; padding: 20px; max-width: 1400px; margin: 0 auto; }
  .section.active { display: block; }

  /* グラフコントロール */
  .graph-controls { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  #mode-indicator { font-weight: bold; padding: 5px 15px; border-left: 4px solid #e94560; }

  .btn-action { background: #0f3460; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
  .btn-reset { background: #533483; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; }

  .sub-nav-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
  .sub-nav-btn { background: white; border: 1px solid #0f3460; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
  .sub-nav-btn.active { background: #0f3460; color: white; }

  .graph-view { display: none; }
  .graph-view.active { display: block; }
  .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
  .chart-container { position: relative; height: 400px; width: 100%; }

  #map-container { height: 650px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
  #map { width: 100%; height: 100%; }

  /* テーブルスタイル */
  .table-tools { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; gap: 20px; align-items: center; }
  #table-wrapper { background: white; border-radius: 12px; overflow: auto; max-height: 700px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
  table { width: 100%; border-collapse: collapse; min-width: 1000px; }
  th { background: #1a1a2e; color: white; position: sticky; top: 0; padding: 12px; }
  td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
  tr:hover { background: #f9f9f9; }
  .summary-row { background: #f0f7ff !important; font-weight: bold; }
</style>
</head>
<body>

<header>
  <button id="btn-graphs" class="main-nav active">グラフ表示</button>
  <button id="btn-map" class="main-nav">GPSマップ表示</button>
  <button id="btn-table" class="main-nav">過去データ・集計</button>
</header>

<div id="graph-section" class="section active">
  <div class="graph-controls">
    <div id="mode-indicator">リアル</div>
    <input type="time" id="graph-start-time" value="00:00"> 〜 
    <input type="time" id="graph-end-time" value="23:59">
    <button class="btn-action" onclick="applyGraphFilter()">指定</button>
    <button class="btn-reset" onclick="resetGraphToRealtime()">リアルに戻す</button>
  </div>

  <div class="sub-nav-container">
    <button class="sub-nav-btn active" onclick="switchGraphMode('overview')">全体 (Power)</button>
    <button class="sub-nav-btn" onclick="switchGraphMode('panel')">PANEL (V/I)</button>
    <button class="sub-nav-btn" onclick="switchGraphMode('batt')">BATTERY (V/I)</button>
    <button class="sub-nav-btn" onclick="switchGraphMode('load')">LOAD (V/I)</button>
  </div>

  <div id="view-overview" class="graph-view active">
    <div class="card"><h3>Total Power Consumption & Generation (W)</h3><div class="chart-container"><canvas id="chart-total-power"></canvas></div></div>
  </div>
  <div id="view-panel" class="graph-view">
    <div class="card"><h3>Panel Voltage & Current</h3><div class="chart-container"><canvas id="chart-panel-vi"></canvas></div></div>
  </div>
  <div id="view-batt" class="graph-view">
    <div class="card"><h3>Battery Voltage & Current</h3><div class="chart-container"><canvas id="chart-batt-vi"></canvas></div></div>
  </div>
  <div id="view-load" class="graph-view">
    <div class="card"><h3>Load Voltage & Current</h3><div class="chart-container"><canvas id="chart-load-vi"></canvas></div></div>
  </div>
</div>

<div id="map-section" class="section"><div id="map-container"><div id="map"></div></div></div>

<div id="table-section" class="section">
  <div class="table-tools">
    <input type="date" id="date-picker">
    <select id="agg-mode">
      <option value="raw">生データ</option>
      <option value="1min">1分平均</option>
      <option value="1hour">1時間平均</option>
    </select>
    <button class="btn-action" onclick="downloadCSV()">CSV保存</button>
  </div>
  <div id="table-wrapper">
    <table id="data-table">
      <thead>
        <tr><th>Time (JST)</th><th>Alt(m)</th><th>Lat</th><th>Lng</th><th>PV(V)</th><th>PI(A)</th><th>BV(V)</th><th>BI(A)</th><th>LV(V)</th><th>LI(A)</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616",
  storageBucket: "dronesgps-f3616.firebasestorage.app",
  messagingSenderId: "1068524436957",
  appId: "1:1068524436957:web:dbd9ec480ced3065314a34",
  measurementId: "G-STNDL06MJT"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let allDataLog = [];
let isFilterMode = false;
let charts = {};

// 日付初期化
document.getElementById('date-picker').valueAsDate = new Date();

// グラフ生成
function initCharts(xMin = '00:00', xMax = '23:59') {
  const labels = generateLabels(xMin, xMax);
  const commonOpt = {
    responsive: true, maintainAspectRatio: false, animation: false,
    scales: { x: { labels: labels, ticks: { maxTicksLimit: 12 } } }
  };

  charts.power = new Chart(document.getElementById('chart-total-power'), {
    type: 'line',
    data: { datasets: [
      {label:'Panel(W)', borderColor:'#f1c40f', data:[], pointRadius:0},
      {label:'Battery(W)', borderColor:'#e67e22', data:[], pointRadius:0},
      {label:'Load(W)', borderColor:'#e74c3c', data:[], pointRadius:0}
    ]},
    options: commonOpt
  });

  ['panel', 'batt', 'load'].forEach(key => {
    charts[key] = new Chart(document.getElementById(`chart-${key}-vi`), {
      type: 'line',
      data: { datasets: [
        {label:'Voltage(V)', borderColor:'#3498db', data:[], yAxisID:'y', pointRadius:0},
        {label:'Current(I)', borderColor:'#2ecc71', data:[], yAxisID:'y1', pointRadius:0}
      ]},
      options: { ...commonOpt, scales: { 
        x: commonOpt.scales.x, 
        y: {type:'linear', position:'left'}, 
        y1: {type:'linear', position:'right', grid:{drawOnChartArea:false}}
      }}
    });
  });
}

function generateLabels(start, end) {
  let res = [];
  let curr = new Date(`2025-01-01T${start}:00`);
  let stop = new Date(`2025-01-01T${end}:59`);
  while(curr <= stop) {
    res.push(curr.toTimeString().substring(0, 5));
    curr.setMinutes(curr.getMinutes() + 1);
  }
  return res;
}

// データ受信・プロット
onValue(ref(db, "latest"), (snap) => {
  const raw = snap.val(); if(!raw) return;
  const now = new Date();
  const timeStr = now.toTimeString().substring(0, 5);
  
  const d = {
    time: timeStr, dateStr: now.toLocaleDateString('ja-JP'), fullTime: now.toLocaleTimeString('ja-JP'),
    pv: Number(raw.battery?.voltage || 0), pi: Number(raw.battery?.current || 0),
    bv: Number(raw.panel?.voltage || 0), bi: Number(raw.panel?.current || 0),
    lv: Number(raw.load?.voltage || 0), li: Number(raw.load?.current || 0),
    lat: raw.GPS?.lat || 0, lng: raw.GPS?.lng || 0, alt: raw.GPS?.alt || 0
  };
  d.pp = d.pv * d.pi; d.bp = d.bv * d.bi; d.lp = d.lv * d.li;
  allDataLog.unshift(d);

  if(!isFilterMode) {
    const idx = charts.power.options.scales.x.labels.indexOf(timeStr);
    if(idx !== -1) {
      charts.power.data.datasets[0].data[idx] = d.pp;
      charts.power.data.datasets[1].data[idx] = d.bp;
      charts.power.data.datasets[2].data[idx] = d.lp;
      
      charts.panel.data.datasets[0].data[idx] = d.pv; charts.panel.data.datasets[1].data[idx] = d.pi;
      charts.batt.data.datasets[0].data[idx] = d.bv; charts.batt.data.datasets[1].data[idx] = d.bi;
      charts.load.data.datasets[0].data[idx] = d.lv; charts.load.data.datasets[1].data[idx] = d.li;
      
      Object.values(charts).forEach(c => c.update('none'));
    }
  }
  updateTable();
});

// UI制御
window.showSection = (name) => {
  document.querySelectorAll('.section, .main-nav').forEach(el => el.classList.remove('active'));
  document.getElementById(`${name}-section`).classList.add('active');
  document.getElementById(`btn-${name}`).classList.add('active');
  if(name === 'graphs') setTimeout(() => Object.values(charts).forEach(c => { c.resize(); c.update(); }), 50);
  if(name === 'map') setTimeout(() => map.invalidateSize(), 200);
};

window.switchGraphMode = (mode) => {
  document.querySelectorAll('.sub-nav-btn, .graph-view').forEach(el => el.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(`view-${mode}`).classList.add('active');
  setTimeout(() => Object.values(charts).forEach(c => c.resize()), 50);
};

// フィルタ
window.applyGraphFilter = () => {
  isFilterMode = true; document.getElementById('mode-indicator').innerText = "指定";
  const start = document.getElementById('graph-start-time').value;
  const end = document.getElementById('graph-end-time').value;
  const labels = generateLabels(start, end);
  Object.values(charts).forEach(c => {
    c.options.scales.x.labels = labels;
    c.data.datasets.forEach(ds => ds.data = []); // 一旦クリア
    c.update();
  });
  // 過去ログから再描画
  const today = new Date().toLocaleDateString('ja-JP');
  allDataLog.filter(d => d.dateStr === today && d.time >= start && d.time <= end).forEach(d => {
    const idx = labels.indexOf(d.time);
    if(idx !== -1) {
      charts.power.data.datasets[0].data[idx] = d.pp; charts.power.data.datasets[1].data[idx] = d.bp; charts.power.data.datasets[2].data[idx] = d.lp;
      charts.panel.data.datasets[0].data[idx] = d.pv; charts.panel.data.datasets[1].data[idx] = d.pi;
      charts.batt.data.datasets[0].data[idx] = d.bv; charts.batt.data.datasets[1].data[idx] = d.bi;
      charts.load.data.datasets[0].data[idx] = d.lv; charts.load.data.datasets[1].data[idx] = d.li;
    }
  });
  Object.values(charts).forEach(c => c.update());
};

window.resetGraphToRealtime = () => {
  isFilterMode = false; document.getElementById('mode-indicator').innerText = "リアル";
  const labels = generateLabels('00:00', '23:59');
  Object.values(charts).forEach(c => { c.options.scales.x.labels = labels; c.data.datasets.forEach(ds => ds.data = []); c.update(); });
};

// テーブル・集計
function updateTable() {
  const tbody = document.querySelector('#data-table tbody');
  const mode = document.getElementById('agg-mode').value;
  const targetDate = new Date(document.getElementById('date-picker').value).toLocaleDateString('ja-JP');
  const filtered = allDataLog.filter(d => d.dateStr === targetDate);
  
  let displayData = filtered;
  if (mode !== 'raw') {
    const groups = {};
    filtered.forEach(d => {
      const key = (mode === '1min') ? d.time : d.time.split(':')[0] + ":00";
      if (!groups[key]) groups[key] = { t: key, count: 0, pv:0, pi:0, bv:0, bi:0, lv:0, li:0, alt:0, lat:0, lng:0 };
      const g = groups[key];
      g.count++; g.pv += d.pv; g.pi += d.pi; g.bv += d.bv; g.bi += d.bi; g.lv += d.lv; g.li += d.li;
      g.alt += d.alt; g.lat += d.lat; g.lng += d.lng;
    });
    displayData = Object.values(groups).map(g => ({
      time: g.t, isAgg: true,
      pv: (g.pv/g.count).toFixed(2), pi: (g.pi/g.count).toFixed(2),
      bv: (g.bv/g.count).toFixed(2), bi: (g.bi/g.count).toFixed(2),
      lv: (g.lv/g.count).toFixed(2), li: (g.li/g.count).toFixed(2),
      alt: (g.alt/g.count).toFixed(1), lat: (g.lat/g.count).toFixed(6), lng: (g.lng/g.count).toFixed(6)
    }));
  }

  tbody.innerHTML = displayData.slice(0, 100).map(d => `
    <tr class="${d.isAgg ? 'summary-row' : ''}">
      <td>${d.time}</td><td>${d.alt}</td><td>${d.lat}</td><td>${d.lng}</td>
      <td>${d.pv}</td><td>${d.pi}</td><td>${d.bv}</td><td>${d.bi}</td><td>${d.lv}</td><td>${d.li}</td>
    </tr>`).join('');
}

document.getElementById('agg-mode').onchange = updateTable;
document.getElementById('date-picker').onchange = updateTable;

// マップ
const map = L.map("map").setView([35, 135], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

initCharts();
</script>
</body>
</html>
