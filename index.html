<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Monitor - History Graph Pro</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* 基本デザイン */
  body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; color: #333; }
  header { display: flex; justify-content: center; gap: 20px; background: #2c3e50; padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
  header button { background: #34495e; color: #ecf0f1; border: none; padding: 10px 30px; border-radius: 30px; cursor: pointer; font-weight: bold; }
  header button.active { background: #e74c3c; }

  .section { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
  .section.active { display: block; }
  
  .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
  .chart-box { position: relative; height: 350px; width: 100%; }
  
  /* 操作パネル */
  .control-panel { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .btn-primary { background: #2980b9; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
  .btn-orange { background: #e67e22; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }

  table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
  th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px; }
  th { background: #2c3e50; color: white; }
</style>
</head>
<body>

<header>
  <button id="nav-graphs" class="active" onclick="switchSection('graphs')">リアルタイム表示</button>
  <button id="nav-table" onclick="switchSection('table')">過去データ・履歴グラフ</button>
</header>

<div id="sec-graphs" class="section active">
  <div class="card">
    <h3>Real-time Power (Watts)</h3>
    <div class="chart-box"><canvas id="c-realtime-power"></canvas></div>
  </div>
</div>

<div id="sec-table" class="section">
  <div class="control-panel">
    <div><b>日付:</b> <input type="date" id="date-picker"></div>
    <div><b>期間:</b> <input type="time" id="h-start" value="00:00"> 〜 <input type="time" id="h-end" value="23:59"></div>
    <button class="btn-primary" onclick="updateHistoryView()">グラフ・表示を更新</button>
    <button class="btn-orange" onclick="downloadCSV()">CSV保存</button>
  </div>

  <div class="card">
    <h3 id="history-title">指定日の電力推移グラフ (Power)</h3>
    <div class="chart-box"><canvas id="c-history-graph"></canvas></div>
  </div>

  <div class="card">
    <h3>詳細ログ一覧</h3>
    <div style="overflow-x:auto; max-height: 400px;">
      <table id="data-tbl">
        <thead>
          <tr><th>Time</th><th>Panel(W)</th><th>Batt(W)</th><th>Load(W)</th><th>P-Volt(V)</th><th>B-Volt(V)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let allDataLog = [];
let charts = {};

// --- 初期化 ---
document.getElementById('date-picker').valueAsDate = new Date();

function initCharts() {
  const options = { responsive: true, maintainAspectRatio: false, animation: false };
  
  // リアルタイムグラフ
  charts.realtime = new Chart(document.getElementById('c-realtime-power'), {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'Panel', borderColor: '#f1c40f', data: [] },
      { label: 'Battery', borderColor: '#e67e22', data: [] },
      { label: 'Load', borderColor: '#e74c3c', data: [] }
    ]},
    options: options
  });

  // 履歴グラフ
  charts.history = new Chart(document.getElementById('c-history-graph'), {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'Panel Power(W)', borderColor: '#f1c40f', backgroundColor: 'rgba(241,196,15,0.1)', fill: true, data: [] },
      { label: 'Battery Power(W)', borderColor: '#e67e22', backgroundColor: 'rgba(230,126,34,0.1)', fill: true, data: [] },
      { label: 'Load Power(W)', borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: true, data: [] }
    ]},
    options: { ...options, scales: { x: { title: { display: true, text: '時間' } } } }
  });
}
initCharts();

// --- データ受信 ---
onValue(ref(db, "latest"), (snap) => {
  const raw = snap.val(); if (!raw) return;

  const now = new Date();
  const d = {
    t: now.toTimeString().substring(0, 8), // HH:MM:SS
    date: now.toISOString().split('T')[0], // YYYY-MM-DD
    pv: Number(raw.battery?.voltage || 0), pi: Number(raw.battery?.current || 0), // Swap
    bv: Number(raw.panel?.voltage || 0), bi: Number(raw.panel?.current || 0),   // Swap
    lv: Number(raw.load?.voltage || 0), li: Number(raw.load?.current || 0),
  };
  d.pp = (d.pv * d.pi).toFixed(2); 
  d.bp = (d.bv * d.bi).toFixed(2); 
  d.lp = (d.lv * d.li).toFixed(2);

  allDataLog.unshift(d);
  if (allDataLog.length > 5000) allDataLog.pop(); // メモリ保護

  // リアルタイムグラフ更新
  const rt = charts.realtime;
  rt.data.labels.push(d.t);
  rt.data.datasets[0].data.push(d.pp);
  rt.data.datasets[1].data.push(d.bp);
  rt.data.datasets[2].data.push(d.lp);
  if (rt.data.labels.length > 30) { rt.data.labels.shift(); rt.data.datasets.forEach(ds => ds.data.shift()); }
  rt.update();
});

// --- 過去データ表示更新ロジック ---
window.updateHistoryView = () => {
  const targetDate = document.getElementById('date-picker').value;
  const startTime = document.getElementById('h-start').value;
  const endTime = document.getElementById('h-end').value;

  // フィルタリング
  const filtered = allDataLog.filter(d => 
    d.date === targetDate && d.t >= startTime && d.t <= endTime
  ).reverse(); // グラフ用に時間を正順に

  // グラフ更新
  charts.history.data.labels = filtered.map(d => d.t);
  charts.history.data.datasets[0].data = filtered.map(d => d.pp);
  charts.history.data.datasets[1].data = filtered.map(d => d.bp);
  charts.history.data.datasets[2].data = filtered.map(d => d.lp);
  charts.history.update();

  // テーブル更新
  const tbody = document.querySelector('#data-tbl tbody');
  tbody.innerHTML = filtered.slice().reverse().map(d => `
    <tr>
      <td>${d.t}</td><td>${d.pp}</td><td>${d.bp}</td><td>${d.lp}</td><td>${d.pv}</td><td>${d.bv}</td>
    </tr>
  `).join('');

  document.getElementById('history-title').innerText = `${targetDate} [${startTime}〜${endTime}] の推移`;
};

// --- UI操作 ---
window.switchSection = (id) => {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('header button').forEach(b => b.classList.remove('active'));
  document.getElementById(`sec-${id}`).classList.add('active');
  document.getElementById(`nav-${id}`).classList.add('active');
  if (id === 'table') updateHistoryView(); // 切り替え時に自動表示
};

window.downloadCSV = () => {
  const rows = [["Time", "Panel(W)", "Batt(W)", "Load(W)"]];
  const targetDate = document.getElementById('date-picker').value;
  allDataLog.filter(d => d.date === targetDate).forEach(d => rows.push([d.t, d.pp, d.bp, d.lp]));
  let csv = "\uFEFF" + rows.map(e => e.join(",")).join("\n");
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `drone_log_${targetDate}.csv`;
  link.click();
};
</script>
</body>
</html>
