<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Power Monitor Ultimate</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* ===== デザイン設定 ===== */
  body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; color: #333; }
  header { display: flex; justify-content: center; gap: 15px; background: #1e1e2f; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  header button { background: #3b3b5f; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.3s; }
  header button.active { background: #ff6f61; }

  .section { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
  .section.active { display: block; animation: fadeIn 0.3s; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* グラフ操作バー */
  .control-panel { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .mode-badge { font-weight: bold; padding: 5px 12px; border-radius: 4px; background: #eee; border-left: 5px solid #e74c3c; }

  /* サブメニュー (詳細ボタン) */
  .sub-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
  .sub-nav button { background: white; border: 1px solid #3b3b5f; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
  .sub-nav button.active { background: #3b3b5f; color: white; }

  /* グラフ表示エリア */
  .graph-view { display: none; }
  .graph-view.active { display: block; }
  .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
  .chart-box { position: relative; height: 400px; width: 100%; }

  /* マップ */
  #map { width: 100%; height: 600px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

  /* テーブル */
  table { width: 100%; border-collapse: collapse; background: white; }
  th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
  th { background: #3b3b5f; color: white; }
  .summary-row { background: #e3f2fd; font-weight: bold; }
</style>
</head>
<body>

<header>
  <button id="nav-graphs" class="active" onclick="switchSection('graphs')">グラフ表示</button>
  <button id="nav-map" onclick="switchSection('map')">GPSマップ表示</button>
  <button id="nav-table" onclick="switchSection('table')">過去データ・集計</button>
</header>

<div id="sec-graphs" class="section active">
  <div class="control-panel">
    <div id="mode-text" class="mode-badge">リアルタイム配信中</div>
    <input type="date" id="g-date">
    <input type="time" id="g-start" value="00:00"> 〜 <input type="time" id="g-end" value="23:59">
    <button onclick="applyHistoryGraph()" style="background:#2980b9; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">履歴グラフをプロット</button>
    <button onclick="resetToRealtime()" style="background:#e67e22; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">リアルタイムに戻す</button>
  </div>

  <div class="sub-nav">
    <button id="sub-overview" class="active" onclick="switchGraphSub('overview')">全体 (Power)</button>
    <button id="sub-panel" onclick="switchGraphSub('panel')">PANEL 詳細</button>
    <button id="sub-batt" onclick="switchGraphSub('batt')">BATTERY 詳細</button>
    <button id="sub-load" onclick="switchGraphSub('load')">LOAD 詳細</button>
  </div>

  <div id="view-overview" class="graph-view active">
    <div class="card"><h3>Power Trend (W)</h3><div class="chart-box"><canvas id="c-pwr"></canvas></div></div>
  </div>
  <div id="view-panel" class="graph-view">
    <div class="card"><h3>Panel Detail (V/I)</h3><div class="chart-box"><canvas id="c-p-vi"></canvas></div></div>
  </div>
  <div id="view-batt" class="graph-view">
    <div class="card"><h3>Battery Detail (V/I)</h3><div class="chart-box"><canvas id="c-b-vi"></canvas></div></div>
  </div>
  <div id="view-load" class="graph-view">
    <div class="card"><h3>Load Detail (V/I)</h3><div class="chart-box"><canvas id="c-l-vi"></canvas></div></div>
  </div>
</div>

<div id="sec-map" class="section">
  <div id="map"></div>
</div>

<div id="sec-table" class="section">
  <div class="control-panel">
    <input type="date" id="t-date">
    <select id="t-agg">
      <option value="raw">生データ</option>
      <option value="1min">1分平均</option>
      <option value="1hour">1時間平均</option>
    </select>
    <button class="btn-primary" onclick="renderTable()" style="background:#2c3e50; color:white; padding:8px 15px; border-radius:4px; border:none; cursor:pointer;">テーブル更新</button>
    <button onclick="downloadCSV()" style="background:#27ae60; color:white; padding:8px 15px; border-radius:4px; border:none; cursor:pointer;">CSV保存</button>
  </div>
  <div style="overflow-x:auto; max-height:600px;"><table id="data-tbl"><thead><tr><th>Time</th><th>Lat</th><th>Lng</th><th>P-V</th><th>P-I</th><th>B-V</th><th>B-I</th><th>L-V</th><th>L-I</th></tr></thead><tbody></tbody></table></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- 変数管理 ---
let allDataLog = [];
let isFilterMode = false;
let charts = {};
const MAX_RT_POINTS = 40;

// 初期化
document.querySelectorAll('input[type="date"]').forEach(i => i.valueAsDate = new Date());

// --- グラフ初期化 ---
function createChart(id, datasets, dual = false) {
  const ctx = document.getElementById(id).getContext('2d');
  const scales = { x: { ticks: { maxTicksLimit: 12 } } };
  if (dual) {
    scales.y = { type: 'linear', position: 'left', title: { display: true, text: 'Voltage (V)' } };
    scales.y1 = { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Current (A)' } };
  }
  return new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: datasets },
    options: { responsive: true, maintainAspectRatio: false, animation: false, scales: scales, elements: { point: { radius: 0 } } }
  });
}

charts.pwr = createChart('c-pwr', [
  { label: 'Panel(W)', borderColor: '#f1c40f', data: [] },
  { label: 'Batt(W)', borderColor: '#e67e22', data: [] },
  { label: 'Load(W)', borderColor: '#e74c3c', data: [] }
]);
const viDs = (l1, l2) => [{ label: l1, borderColor: '#2980b9', yAxisID: 'y', data: [] }, { label: l2, borderColor: '#2ecc71', yAxisID: 'y1', data: [] }];
charts.pVI = createChart('c-p-vi', viDs('P-Volt', 'P-Curr'), true);
charts.bVI = createChart('c-b-vi', viDs('B-Volt', 'B-Curr'), true);
charts.lVI = createChart('c-l-vi', viDs('L-Volt', 'L-Curr'), true);

// --- マップ初期化 ---
const map = L.map("map").setView([35, 135], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let marker = L.marker([35, 135]).addTo(map);

// --- データ受信 ---
onValue(ref(db, "latest"), (snap) => {
  const raw = snap.val(); if (!raw) return;
  const now = new Date();
  const d = {
    t: now.toTimeString().substring(0, 8),
    date: now.toISOString().split('T')[0],
    pv: Number(raw.battery?.voltage || 0), pi: Number(raw.battery?.current || 0), // Swap
    bv: Number(raw.panel?.voltage || 0), bi: Number(raw.panel?.current || 0),   // Swap
    lv: Number(raw.load?.voltage || 0), li: Number(raw.load?.current || 0),
    lat: raw.GPS?.lat || 0, lng: raw.GPS?.lng || 0
  };
  d.pp = d.pv * d.pi; d.bp = d.bv * d.bi; d.lp = d.lv * d.li;

  allDataLog.unshift(d);
  if (allDataLog.length > 5000) allDataLog.pop();

  if (!isFilterMode) {
    updateRt(charts.pwr, d.t, [d.pp, d.bp, d.lp]);
    updateRt(charts.pVI, d.t, [d.pv, d.pi]);
    updateRt(charts.bVI, d.t, [d.bv, d.bi]);
    updateRt(charts.lVI, d.t, [d.lv, d.li]);
    marker.setLatLng([d.lat, d.lng]);
    map.panTo([d.lat, d.lng]);
  }
});

function updateRt(chart, label, vals) {
  chart.data.labels.push(label);
  vals.forEach((v, i) => chart.data.datasets[i].data.push(v));
  if (chart.data.labels.length > MAX_RT_POINTS) {
    chart.data.labels.shift();
    chart.data.datasets.forEach(ds => ds.data.shift());
  }
  chart.update();
}

// --- 履歴グラフプロット機能 ---
window.applyHistoryGraph = () => {
  const date = document.getElementById('g-date').value;
  const start = document.getElementById('g-start').value;
  const end = document.getElementById('g-end').value;
  
  const filtered = allDataLog.filter(d => d.date === date && d.t >= start && d.t <= end).reverse();
  if (filtered.length === 0) return alert("指定期間のデータがありません");

  isFilterMode = true;
  document.getElementById('mode-text').innerText = "履歴表示中";
  document.getElementById('mode-text').style.borderLeftColor = "#2980b9";

  const plot = (chart, keys) => {
    chart.data.labels = filtered.map(d => d.t);
    keys.forEach((k, i) => chart.data.datasets[i].data = filtered.map(d => d[k]));
    chart.update();
  };

  plot(charts.pwr, ['pp', 'bp', 'lp']);
  plot(charts.pVI, ['pv', 'pi']);
  plot(charts.bVI, ['bv', 'bi']);
  plot(charts.lVI, ['lv', 'li']);
};

window.resetToRealtime = () => {
  isFilterMode = false;
  document.getElementById('mode-text').innerText = "リアルタイム配信中";
  document.getElementById('mode-text').style.borderLeftColor = "#e74c3c";
  Object.values(charts).forEach(c => { c.data.labels = []; c.data.datasets.forEach(ds => ds.data = []); c.update(); });
};

// --- UI / テーブル制御 ---
window.switchSection = (id) => {
  document.querySelectorAll('.section, header button').forEach(el => el.classList.remove('active'));
  document.getElementById(`sec-${id}`).classList.add('active');
  document.getElementById(`nav-${id}`).classList.add('active');
  if (id === 'map') setTimeout(() => map.invalidateSize(), 200);
};

window.switchGraphSub = (id) => {
  document.querySelectorAll('.graph-view, .sub-nav button').forEach(el => el.classList.remove('active'));
  document.getElementById(`view-${id}`).classList.add('active');
  document.getElementById(`sub-${id}`).classList.add('active');
};

window.renderTable = () => {
  const date = document.getElementById('t-date').value;
  const mode = document.getElementById('t-agg').value;
  const tbody = document.querySelector('#data-tbl tbody');
  let data = allDataLog.filter(d => d.date === date);

  if (mode !== 'raw') {
    const groups = {};
    data.forEach(d => {
      let k = (mode === '1min') ? d.t.substring(0,5) : d.t.substring(0,2)+":00";
      if(!groups[k]) groups[k] = { t:k, c:0, lat:0, lng:0, pv:0, pi:0, bv:0, bi:0, lv:0, li:0 };
      const g = groups[k]; g.c++;
      ['lat','lng','pv','pi','bv','bi','lv','li'].forEach(f => g[f]+=d[f]);
    });
    data = Object.values(groups).map(g => ({ t:g.t, isAgg:true, lat:g.lat/g.c, lng:g.lng/g.c, pv:g.pv/g.c, pi:g.pi/g.c, bv:g.bv/g.c, bi:g.bi/g.c, lv:g.lv/g.c, li:g.li/g.c }));
  }

  tbody.innerHTML = data.map(d => `<tr class="${d.isAgg?'summary-row':''}"><td>${d.t}</td><td>${d.lat.toFixed(4)}</td><td>${d.lng.toFixed(4)}</td><td>${Number(d.pv).toFixed(2)}</td><td>${Number(d.pi).toFixed(2)}</td><td>${Number(d.bv).toFixed(2)}</td><td>${Number(d.bi).toFixed(2)}</td><td>${Number(d.lv).toFixed(2)}</td><td>${Number(d.li).toFixed(2)}</td></tr>`).join('');
};

window.downloadCSV = () => {
  const rows = [["Time","Lat","Lng","PV","PI","BV","BI","LV","LI"]];
  document.querySelectorAll('#data-tbl tr:not(:first-child)').forEach(tr => rows.push(Array.from(tr.querySelectorAll('td')).map(td => td.innerText)));
  const link = document.createElement("a");
  link.href = URL.createObjectURL(new Blob(["\uFEFF" + rows.map(e => e.join(",")).join("\n")], { type: "text/csv" }));
  link.download = "drone_data.csv"; link.click();
};
</script>
</body>
</html>
