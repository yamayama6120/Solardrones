<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Dashboard Pro - Graph Focus</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; background: #f0f2f5; color: #333; }
  header { display: flex; justify-content: center; gap: 15px; background: #1a1a2e; padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
  
  .main-nav { background: #303050; color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; }
  .main-nav.active { background: #ff4757; }

  .section { display: none; padding: 20px; max-width: 1000px; margin: 0 auto; }
  .section.active { display: block; }
  
  .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
  h3 { margin-top: 0; color: #1a1a2e; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }

  /* グラフ切り替えボタン */
  .sub-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
  .sub-btn { background: #fff; border: 1px solid #ddd; padding: 8px 18px; border-radius: 5px; cursor: pointer; font-weight: bold; }
  .sub-btn.active { background: #1a1a2e; color: white; border-color: #1a1a2e; }

  .graph-container { display: none; flex-direction: column; gap: 20px; }
  .graph-container.active { display: flex; }

  /* グラフサイズ調整：縦に大きく並べる */
  .chart-wrapper { position: relative; height: 400px; width: 100%; }

  #map { height: 600px; width: 100%; border-radius: 10px; }

  /* テーブル・コントロール */
  .controls { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; }
  .table-wrapper { overflow-x: auto; background: white; border-radius: 10px; border: 1px solid #eee; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th, td { padding: 12px; border: 1px solid #eee; text-align: center; }
  th { background: #f8f9fa; }
  
  button.action-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
</style>
</head>
<body>

<header>
  <button class="main-nav active" onclick="showSection('graphs')">グラフ表示</button>
  <button class="main-nav" onclick="showSection('map')">GPSマップ</button>
  <button class="main-nav" onclick="showSection('table')">データ集計</button>
</header>

<div id="sec-graphs" class="section active">
  <div class="sub-nav">
    <button class="sub-btn active" onclick="switchGraph('ov')">全体(W)</button>
    <button class="sub-btn" onclick="switchGraph('panel')">Panel詳細</button>
    <button class="sub-btn" onclick="switchGraph('batt')">Battery詳細</button>
    <button class="sub-btn" onclick="switchGraph('load')">Load詳細</button>
  </div>

  <div id="view-ov" class="graph-container active">
    <div class="card"><h3>Panel Power (Watts)</h3><div class="chart-wrapper"><canvas id="c-ov-p"></canvas></div></div>
    <div class="card"><h3>Battery Power (Watts)</h3><div class="chart-wrapper"><canvas id="c-ov-b"></canvas></div></div>
    <div class="card"><h3>Load Power (Watts)</h3><div class="chart-wrapper"><canvas id="c-ov-l"></canvas></div></div>
  </div>

  <div id="view-panel" class="graph-container">
    <div class="card"><h3>Panel Voltage (V)</h3><div class="chart-wrapper"><canvas id="c-p-v"></canvas></div></div>
    <div class="card"><h3>Panel Current (mA)</h3><div class="chart-wrapper"><canvas id="c-p-i"></canvas></div></div>
  </div>

  <div id="view-batt" class="graph-container">
    <div class="card"><h3>Battery Voltage (V)</h3><div class="chart-wrapper"><canvas id="c-b-v"></canvas></div></div>
    <div class="card"><h3>Battery Current (mA)</h3><div class="chart-wrapper"><canvas id="c-b-i"></canvas></div></div>
  </div>

  <div id="view-load" class="graph-container">
    <div class="card"><h3>Load Voltage (V)</h3><div class="chart-wrapper"><canvas id="c-l-v"></canvas></div></div>
    <div class="card"><h3>Load Current (mA)</h3><div class="chart-wrapper"><canvas id="c-l-i"></canvas></div></div>
  </div>
</div>

<div id="sec-map" class="section">
  <div class="card"><div id="map"></div></div>
</div>

<div id="sec-table" class="section">
  <div class="card">
    <div class="controls">
      <input type="date" id="target-date">
      <button class="action-btn" onclick="refreshTable()">更新</button>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>時刻</th><th>緯度</th><th>経度</th><th>Panel(W)</th><th>Batt(W)</th><th>Load(W)</th></tr>
        </thead>
        <tbody id="log-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let allData = [];
let map, marker, pathLine;
const charts = {};
const MAX_POINTS = 40;

// --- グラフ初期化 (個別グラフ生成) ---
function initCharts() {
  const cfg = (label, color, unit) => ({
    type: 'line',
    data: { labels: [], datasets: [{ label: `${label} (${unit})`, data: [], borderColor: color, backgroundColor: color+'22', fill: true, tension: 0.3 }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: true }, y: { beginAtZero: false } } }
  });

  // 全体グラフ
  charts.ovP = new Chart(document.getElementById('c-ov-p'), cfg('Panel', '#f1c40f', 'W'));
  charts.ovB = new Chart(document.getElementById('c-ov-b'), cfg('Battery', '#e67e22', 'W'));
  charts.ovL = new Chart(document.getElementById('c-ov-l'), cfg('Load', '#e74c3c', 'W'));
  
  // 詳細グラフ (個別に用意)
  charts.pV = new Chart(document.getElementById('c-p-v'), cfg('Panel Volt', '#f1c40f', 'V'));
  charts.pI = new Chart(document.getElementById('c-p-i'), cfg('Panel Current', '#2ecc71', 'mA'));
  charts.bV = new Chart(document.getElementById('c-b-v'), cfg('Batt Volt', '#e67e22', 'V'));
  charts.bI = new Chart(document.getElementById('c-b-i'), cfg('Batt Current', '#3498db', 'mA'));
  charts.lV = new Chart(document.getElementById('c-l-v'), cfg('Load Volt', '#e74c3c', 'V'));
  charts.lI = new Chart(document.getElementById('c-l-i'), cfg('Load Current', '#9b59b6', 'mA'));
}

function initMap() {
  map = L.map('map').setView([35.68, 139.76], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  marker = L.marker([0, 0]).addTo(map);
  pathLine = L.polyline([], { color: 'blue' }).addTo(map);
}

onValue(ref(db, "latest"), (snap) => {
  const d = snap.val(); if (!d) return;
  const now = new Date();
  const timeStr = now.toLocaleTimeString();

  const pW = (d.panel.voltage * d.panel.current_mA / 1000).toFixed(2);
  const bW = (d.battery.voltage * d.battery.current_mA / 1000).toFixed(2);
  const lW = (d.load.voltage * d.load.current_mA / 1000).toFixed(2);

  const entry = {
    ts: now.getTime(), date: now.toISOString().split('T')[0], time: timeStr,
    lat: d.GPS.lat, lng: d.GPS.lng,
    pv: d.panel.voltage, pi: d.panel.current_mA, pp: parseFloat(pW),
    bv: d.battery.voltage, bi: d.battery.current_mA, bp: parseFloat(bW),
    lv: d.load.voltage, li: d.load.current_mA, lp: parseFloat(lW)
  };
  allData.push(entry);

  // 各グラフを更新
  const update = (chart, val) => {
    chart.data.labels.push(timeStr);
    chart.data.datasets[0].data.push(val);
    if(chart.data.labels.length > MAX_POINTS) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
    chart.update('none');
  };

  update(charts.ovP, entry.pp); update(charts.ovB, entry.bp); update(charts.ovL, entry.lp);
  update(charts.pV, entry.pv);  update(charts.pI, entry.pi);
  update(charts.bV, entry.bv);  update(charts.bI, entry.bi);
  update(charts.lV, entry.lv);  update(charts.lI, entry.li);

  const pos = [d.GPS.lat, d.GPS.lng];
  marker.setLatLng(pos);
  pathLine.addLatLng(pos);
});

window.refreshTable = () => {
  const date = document.getElementById('target-date').value;
  const body = document.getElementById('log-body');
  body.innerHTML = allData.filter(d => d.date === date).map(d => `
    <tr><td>${d.time}</td><td>${d.lat.toFixed(5)}</td><td>${d.lng.toFixed(5)}</td><td>${d.pp}</td><td>${d.bp}</td><td>${d.lp}</td></tr>
  `).join('');
};

window.showSection = (id) => {
  document.querySelectorAll('.section, .main-nav').forEach(el => el.classList.remove('active'));
  document.getElementById(`sec-${id}`).classList.add('active');
  event.target.classList.add('active');
  if(id === 'map') setTimeout(() => map.invalidateSize(), 200);
};

window.switchGraph = (id) => {
  document.querySelectorAll('.graph-container, .sub-btn').forEach(el => el.classList.remove('active'));
  document.getElementById(`view-${id}`).classList.add('active');
  event.target.classList.add('active');
};

document.getElementById('target-date').valueAsDate = new Date();
initCharts();
initMap();
</script>
</body>
</html>
