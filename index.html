<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Dashboard - Professional Edition</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* ===== 基本スタイル ===== */
  body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; background: #f0f2f5; color: #333; }
  
  /* 固定ヘッダー */
  header { display: flex; justify-content: center; gap: 15px; background: #1a1a2e; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
  header button { background: #303050; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-size: 15px; font-weight: bold; transition: 0.3s; }
  header button:hover { background: #4a4a70; }
  header button.active { background: #ff4757; box-shadow: 0 0 15px rgba(255, 71, 87, 0.5); }

  /* セクション制御 */
  .section { display: none; padding: 25px; max-width: 1300px; margin: 0 auto; animation: fadeIn 0.4s; }
  .section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* カード・コンテナ */
  .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
  .card h3 { margin-top: 0; color: #1a1a2e; border-left: 5px solid #ff4757; padding-left: 10px; }

  /* グラフの高さ設定（縦に大きく配置） */
  .chart-container-large { position: relative; height: 350px; width: 100%; }
  
  /* サブメニュー */
  .sub-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; }
  .sub-nav button { background: #fff; border: 2px solid #1a1a2e; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
  .sub-nav button.active { background: #1a1a2e; color: white; }

  /* マップ */
  #map-wrapper { height: 650px; border-radius: 15px; overflow: hidden; box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
  #map { width: 100%; height: 100%; }

  /* 操作パネル */
  .control-panel { background: #fff; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
  .control-panel input, .control-panel select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }

  /* テーブル */
  .table-wrapper { overflow-x: auto; border-radius: 10px; }
  table { width: 100%; border-collapse: collapse; background: white; min-width: 900px; }
  th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
  th { background: #1a1a2e; color: white; position: sticky; top: 0; }
  tr:nth-child(even) { background: #fafafa; }
</style>
</head>
<body>

<header>
  <button id="nav-graphs" class="active" onclick="switchMainTab('graphs')">グラフ表示</button>
  <button id="nav-map" onclick="switchMainTab('map')">GPSマップ表示</button>
  <button id="nav-table" onclick="switchMainTab('table')">過去データ・集計</button>
</header>

<div id="section-graphs" class="section active">
  <div class="sub-nav">
    <button id="sub-btn-pwr" class="active" onclick="switchGraphMode('pwr')">電力個別 (Power)</button>
    <button id="sub-btn-vi" onclick="switchGraphMode('vi')">V/I 詳細</button>
  </div>

  <div id="view-pwr" class="graph-view">
    <div class="card"><h3>Panel Power (W)</h3><div class="chart-container-large"><canvas id="chart-p-pwr"></canvas></div></div>
    <div class="card"><h3>Battery Power (W)</h3><div class="chart-container-large"><canvas id="chart-b-pwr"></canvas></div></div>
    <div class="card"><h3>Load Power (W)</h3><div class="chart-container-large"><canvas id="chart-l-pwr"></canvas></div></div>
  </div>

  <div id="view-vi" class="graph-view" style="display:none;">
    <div class="card"><h3>Panel Voltage & Current</h3><div class="chart-container-large"><canvas id="chart-p-vi"></canvas></div></div>
    <div class="card"><h3>Battery Voltage & Current</h3><div class="chart-container-large"><canvas id="chart-b-vi"></canvas></div></div>
    <div class="card"><h3>Load Voltage & Current</h3><div class="chart-container-large"><canvas id="chart-l-vi"></canvas></div></div>
  </div>
</div>

<div id="section-map" class="section">
  <div class="card">
    <h3>Drone Real-time Tracking</h3>
    <div id="map-wrapper"><div id="map"></div></div>
  </div>
</div>

<div id="section-table" class="section">
  <div class="control-panel">
    <div><b>日付:</b> <input type="date" id="hist-date"></div>
    <div><b>期間:</b> <input type="time" id="hist-start" value="00:00"> 〜 <input type="time" id="hist-end" value="23:59"></div>
    <button onclick="plotHistoryChart()" style="background:#2980b9; color:white; border:none; padding:12px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">グラフプロット</button>
    <button onclick="updateDataTable()" style="background:#7f8c8d; color:white; border:none; padding:12px 20px; border-radius:6px; cursor:pointer;">表示更新</button>
  </div>

  <div class="card" id="history-container" style="display:none;">
    <h3>指定期間の電力推移 (Panel, Battery, Load)</h3>
    <div class="chart-container-large"><canvas id="chart-history"></canvas></div>
  </div>

  <div class="card">
    <h3>ログデータ一覧</h3>
    <div class="table-wrapper">
      <table id="log-table">
        <thead>
          <tr><th>Time</th><th>P-Volt</th><th>P-Curr</th><th>B-Volt</th><th>B-Curr</th><th>L-Volt</th><th>L-Curr</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- データ管理 ---
let allDataLog = [];
let charts = {};
const MAX_POINTS = 50;

// --- グラフ初期化 ---
function createLineChart(id, label, color) {
  return new Chart(document.getElementById(id), {
    type: 'line',
    data: { labels: [], datasets: [{ label: label, borderColor: color, backgroundColor: color+'22', data: [], fill: true, tension: 0.3 }] },
    options: { responsive: true, maintainAspectRatio: false, animation: false, elements: { point: { radius: 2 } } }
  });
}

function createDualChart(id, labels) {
  return new Chart(document.getElementById(id), {
    type: 'line',
    data: { labels: [], datasets: [
      { label: labels[0], borderColor: '#3498db', data: [], yAxisID: 'y' },
      { label: labels[1], borderColor: '#2ecc71', data: [], yAxisID: 'y1' }
    ]},
    options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y1: { position: 'right', grid: { drawOnChartArea: false } } } }
  });
}

charts.pPwr = createLineChart('chart-p-pwr', 'Panel(W)', '#f1c40f');
charts.bPwr = createLineChart('chart-b-pwr', 'Battery(W)', '#e67e22');
charts.lPwr = createLineChart('chart-l-pwr', 'Load(W)', '#e74c3c');
charts.pVI = createDualChart('chart-p-vi', ['Voltage(V)', 'Current(A)']);
charts.bVI = createDualChart('chart-b-vi', ['Voltage(V)', 'Current(A)']);
charts.lVI = createDualChart('chart-l-vi', ['Voltage(V)', 'Current(A)']);

charts.hist = new Chart(document.getElementById('chart-history'), {
  type: 'line',
  data: { labels: [], datasets: [
    { label: 'Panel', borderColor: '#f1c40f', data: [] },
    { label: 'Battery', borderColor: '#e67e22', data: [] },
    { label: 'Load', borderColor: '#e74c3c', data: [] }
  ]},
  options: { responsive: true, maintainAspectRatio: false }
});

// --- マップ初期化 (元ロジック準拠) ---
const map = L.map("map").setView([35.0, 135.0], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OSM" }).addTo(map);
let marker = null;

// --- Firebase受信 ---
onValue(ref(db, "latest"), (snap) => {
  const raw = snap.val(); if (!raw) return;

  // Swap logic (Panel/Battery 入れ替え)
  const d = {
    t: new Date().toLocaleTimeString('ja-JP', { hour12: false }),
    date: new Date().toISOString().split('T')[0],
    pv: Number(raw.battery?.voltage || 0), pi: Number(raw.battery?.current || 0),
    bv: Number(raw.panel?.voltage || 0), bi: Number(raw.panel?.current || 0),
    lv: Number(raw.load?.voltage || 0), li: Number(raw.load?.current || 0),
    gps: raw.GPS || { lat: 0, lng: 0 }
  };
  const pp = (d.pv * d.pi).toFixed(2);
  const bp = (d.bv * d.bi).toFixed(2);
  const lp = (d.lv * d.li).toFixed(2);

  // 1. リアルタイムグラフ更新
  const push = (chart, label, vals) => {
    chart.data.labels.push(label);
    vals.forEach((v, i) => chart.data.datasets[i].data.push(v));
    if (chart.data.labels.length > MAX_POINTS) { chart.data.labels.shift(); chart.data.datasets.forEach(ds => ds.data.shift()); }
    chart.update();
  };
  push(charts.pPwr, d.t, [pp]);
  push(charts.bPwr, d.t, [bp]);
  push(charts.lPwr, d.t, [lp]);
  push(charts.pVI, d.t, [d.pv, d.pi]);
  push(charts.bVI, d.t, [d.bv, d.bi]);
  push(charts.lVI, d.t, [d.lv, d.li]);

  // 2. マップ更新 (元ロジック)
  if (d.gps.lat && d.gps.lng) {
    const pos = [d.gps.lat, d.gps.lng];
    if (!marker) {
      marker = L.marker(pos).addTo(map);
      marker.bindPopup(`<b>Current Power</b><br>Panel: ${pp}W`).openPopup();
    } else {
      marker.setLatLng(pos).setPopupContent(`<b>Current Power</b><br>Panel: ${pp}W`);
    }
    map.panTo(pos);
  }

  // 3. ログ記録
  allDataLog.unshift({ ...d, pp, bp, lp });
});

// --- 各種操作関数 ---
window.switchMainTab = (target) => {
  // すべてのセクションとボタンの状態をリセット
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('header button').forEach(b => b.classList.remove('active'));
  
  // 指定したセクションをアクティブ化
  document.getElementById(`section-${target}`).classList.add('active');
  document.getElementById(`nav-${target}`).classList.add('active');
  
  // マップの表示崩れ防止
  if (target === 'map') setTimeout(() => map.invalidateSize(), 200);
};

window.switchGraphMode = (mode) => {
  document.querySelectorAll('.graph-view').forEach(v => v.style.display = 'none');
  document.querySelectorAll('.sub-nav button').forEach(b => b.classList.remove('active'));
  
  document.getElementById(`view-${mode}`).style.display = 'block';
  document.getElementById(`sub-btn-${mode}`).classList.add('active');
};

window.plotHistoryChart = () => {
  const date = document.getElementById('hist-date').value;
  const start = document.getElementById('hist-start').value;
  const end = document.getElementById('hist-end').value;

  const filtered = allDataLog.filter(d => d.date === date && d.t >= start && d.t <= end).reverse();
  
  if (filtered.length === 0) return alert("指定期間のデータが記録されていません。");

  document.getElementById('history-container').style.display = 'block';
  charts.hist.data.labels = filtered.map(d => d.t);
  charts.hist.data.datasets[0].data = filtered.map(d => d.pp);
  charts.hist.data.datasets[1].data = filtered.map(d => d.bp);
  charts.hist.data.datasets[2].data = filtered.map(d => d.lp);
  charts.hist.update();
};

window.updateDataTable = () => {
  const date = document.getElementById('hist-date').value;
  const tbody = document.querySelector('#log-table tbody');
  const data = allDataLog.filter(d => d.date === date);
  tbody.innerHTML = data.map(d => `<tr><td>${d.t}</td><td>${d.pv}</td><td>${d.pi}</td><td>${d.bv}</td><td>${d.bi}</td><td>${d.lv}</td><td>${d.li}</td></tr>`).join('');
};

// 初期設定
document.getElementById('hist-date').valueAsDate = new Date();
</script>
</body>
</html>
