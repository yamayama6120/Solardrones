<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Monitor Minimal</title>

<!-- ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<h2>Drone Monitor</h2>

<!-- ナビ -->
<button onclick="show('graph')">グラフ</button>
<button onclick="show('map')">GPS</button>
<button onclick="show('table')">データ</button>

<hr>

<!-- ===== グラフ ===== -->
<div id="graph">
  <h3>Power</h3>
  <canvas id="p"></canvas>
  <canvas id="b"></canvas>
  <canvas id="l"></canvas>
</div>

<!-- ===== マップ ===== -->
<div id="map" style="display:none">
  <h3>GPS</h3>
  <div id="mapid" style="height:400px"></div>
</div>

<!-- ===== テーブル ===== -->
<div id="table" style="display:none">
  <h3>Log</h3>
  <input type="date" id="date">
  <button onclick="showTable()">表示</button>
  <button onclick="csv()">CSV</button>

  <table border="1">
    <thead>
      <tr>
        <th>Time</th><th>Lat</th><th>Lng</th><th>Alt</th>
        <th>PanelW</th><th>BatteryW</th><th>LoadW</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* Firebase */
const app = initializeApp({
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616"
});
const db = getDatabase(app);

let log = [];

/* グラフ */
const make = (id, label) =>
  new Chart(document.getElementById(id), {
    type: "line",
    data: { labels: [], datasets: [{ label, data: [] }] },
    options: { animation: false }
  });

const gp = make("p", "Panel W");
const gb = make("b", "Battery W");
const gl = make("l", "Load W");

/* マップ */
const map = L.map("mapid").setView([35.68, 139.76], 15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const marker = L.marker([0,0]).addTo(map);
const line = L.polyline([]).addTo(map);

/* Firebase受信 */
onValue(ref(db, "latest"), s => {
  const d = s.val(); if (!d) return;

  const t = new Date();
  const time = t.toLocaleTimeString();
  const date = t.toISOString().split("T")[0];

  const pw = d.panel.voltage * d.panel.current_mA / 1000;
  const bw = d.battery.voltage * d.battery.current_mA / 1000;
  const lw = d.load.voltage * d.load.current_mA / 1000;

  log.push({ date, time, lat:d.GPS.lat, lng:d.GPS.lng, alt:d.GPS.alt, pw, bw, lw });

  const up = (c,v) => { c.data.labels.push(time); c.data.datasets[0].data.push(v); c.update(); };
  up(gp,pw); up(gb,bw); up(gl,lw);

  marker.setLatLng([d.GPS.lat,d.GPS.lng]);
  line.addLatLng([d.GPS.lat,d.GPS.lng]);
});

/* テーブル */
window.showTable = () => {
  const d = document.getElementById("date").value;
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";
  log.filter(x=>x.date===d).forEach(x=>{
    tb.innerHTML += `<tr>
      <td>${x.time}</td><td>${x.lat}</td><td>${x.lng}</td><td>${x.alt}</td>
      <td>${x.pw.toFixed(2)}</td><td>${x.bw.toFixed(2)}</td><td>${x.lw.toFixed(2)}</td>
    </tr>`;
  });
};

/* CSV */
window.csv = () => {
  let c = "time,lat,lng,alt,panelW,batteryW,loadW\n";
  log.forEach(x=>c+=`${x.time},${x.lat},${x.lng},${x.alt},${x.pw},${x.bw},${x.lw}\n`);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([c]));
  a.download = "log.csv";
  a.click();
};

/* 表示切替 */
window.show = id => {
  ["graph","map","table"].forEach(x=>document.getElementById(x).style.display="none");
  document.getElementById(id).style.display="block";
  if(id==="map") setTimeout(()=>map.invalidateSize(),200);
};

document.getElementById("date").valueAsDate = new Date();
</script>

</body>
</html>
