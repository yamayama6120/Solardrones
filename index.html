<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Dashboard Ultimate Fixed (Fixed Time Axis)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script> <style>
  /* ===== CSS設定 ===== */
  body { font-family: 'Arial', sans-serif; margin: 0; background: #f4f6f8; color: #333; }

  /* メインヘッダー */
  header { display: flex; justify-content: center; gap: 15px; background: #1e1e2f; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  header button.main-nav { background: #3b3b5f; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-size: 16px; transition: 0.3s; font-weight: bold; }
  header button.main-nav:hover { background: #5c5c8f; transform: translateY(-2px); }
  header button.main-nav.active { background: #ff6f61; box-shadow: 0 0 10px rgba(255,111,97,0.5); }

  /* セクション共通 */
  .section { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.5s; } /* 最大幅を拡大 */
  .section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* --- グラフセクション用スタイル --- */
  .sub-nav-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
  .sub-nav-btn { background: white; border: 2px solid #3b3b5f; color: #3b3b5f; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
  .sub-nav-btn:hover { background: #eef; }
  .sub-nav-btn.active { background: #3b3b5f; color: white; }

  .graph-view { display: none; }
  .graph-view.active { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
  
  .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); width: 100%; margin-bottom: 20px; } /* グラフ幅を100%に */
  .card h3 { margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; color: #1e1e2f; text-align: center; }
  
  /* グラフキャンバスのサイズ制御 */
  .chart-container-lg { position: relative; height: 400px; width: 100%; } /* 詳細用グラフを縦に大きく */
  .chart-container-sm { position: relative; height: 350px; width: 100%; } /* Overview用グラフを縦に大きく */

  /* --- マップ --- */
  #map-container { height: 600px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  #map { width: 100%; height: 100%; border-radius: 8px; }

  /* --- テーブル --- */
  .table-controls { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; gap: 20px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  #table-wrapper { background: white; border-radius: 12px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; min-width: 800px; }
  th, td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
  th { background: #3b3b5f; color: white; white-space: nowrap; }
  tr:nth-child(even) { background: #f9f9f9; }
  .summary-row { background: #e3f2fd !important; font-weight: bold; }
</style>
</head>
<body>

<header>
  <button id="btn-graphs" class="main-nav active">グラフ表示</button>
  <button id="btn-map" class="main-nav">GPSマップ表示</button>
  <button id="btn-table" class="main-nav">過去データ・集計</button>
</header>

<div id="graph-section" class="section active">
  
  <div class="sub-nav-container">
    <button id="sub-btn-overview" class="sub-nav-btn active">全体 (Overview)</button>
    <button id="sub-btn-panel" class="sub-nav-btn">PANEL 詳細</button>
    <button id="sub-btn-batt" class="sub-nav-btn">BATTERY 詳細</button>
    <button id="sub-btn-load" class="sub-nav-btn">LOAD 詳細</button>
  </div>

  <div id="view-overview" class="graph-view active" style="flex-direction: column;">
    <div class="card">
      <h3>Panel (Data Source: Battery)</h3> 
      <div class="chart-container-sm"><canvas id="chart-panel-all"></canvas></div>
    </div>
    <div class="card">
      <h3>Battery (Data Source: Panel)</h3> 
      <div class="chart-container-sm"><canvas id="chart-batt-all"></canvas></div>
    </div>
    <div class="card">
      <h3>Load</h3>
      <div class="chart-container-sm"><canvas id="chart-load-all"></canvas></div>
    </div>
  </div>

  <div id="view-panel" class="graph-view">
    <div class="card">
      <h3>Panel Voltage (V)</h3>
      <div class="chart-container-lg"><canvas id="chart-panel-v"></canvas></div>
    </div>
    <div class="card">
      <h3>Panel Current (I)</h3>
      <div class="chart-container-lg"><canvas id="chart-panel-i"></canvas></div>
    </div>
  </div>

  <div id="view-batt" class="graph-view">
    <div class="card">
      <h3>Battery Voltage (V)</h3>
      <div class="chart-container-lg"><canvas id="chart-batt-v"></canvas></div>
    </div>
    <div class="card">
      <h3>Battery Current (I)</h3>
      <div class="chart-container-lg"><canvas id="chart-batt-i"></canvas></div>
    </div>
  </div>

  <div id="view-load" class="graph-view">
    <div class="card">
      <h3>Load Voltage (V)</h3>
      <div class="chart-container-lg"><canvas id="chart-load-v"></canvas></div>
    </div>
    <div class="card">
      <h3>Load Current (I)</h3>
      <div class="chart-container-lg"><canvas id="chart-load-i"></canvas></div>
    </div>
  </div>

</div>

<div id="map-section" class="section">
  <div id="map-container">
    <div id="map"></div>
  </div>
</div>

<div id="table-section" class="section">
  <div class="table-controls">
    <div>
      <label><b>日付を選択:</b></label>
      <input type="date" id="date-picker">
    </div>
    <div>
      <button id="btn-toggle-hourly" style="padding:8px 15px; cursor:pointer;">1時間ごとにまとめる (OFF)</button>
    </div>
    <div style="margin-left:auto; font-size:0.9em; color:#666;">
      ※ページを開いてからの受信データを集計します
    </div>
  </div>

  <div id="table-wrapper">
    <table id="data-table">
      <thead>
        <tr>
          <th>Time / Hour</th>
          <th>Panel V</th><th>Panel I</th><th>Panel P</th>
          <th>Batt V</th><th>Batt I</th><th>Batt P</th>
          <th>Load V</th><th>Load I</th><th>Load P</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { startOfDay, addDays, getUnixTime, fromUnixTime, format } from 'date-fns';

// ==========================================
// 0. Firebase Setup
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616",
  storageBucket: "dronesgps-f3616.firebasestorage.app",
  messagingSenderId: "1068524436957",
  appId: "1:1068524436957:web:dbd9ec480ced3065314a34",
  measurementId: "G-STNDL06MJT"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ==========================================
// 1. グローバル変数 & 日付管理
// ==========================================
let allDataLog = []; 
let isHourlyMode = false;
let currentDay = startOfDay(new Date()); // 今日の0時 JST (ローカルタイムゾーン)

document.getElementById('date-picker').valueAsDate = new Date();

// ==========================================
// 2. ユーティリティ関数
// ==========================================

/**
 * タイムスタンプをJST（日本時間）のDateオブジェクトに変換する
 * @param {number} timestamp - Unix Timestamp (秒)
 * @returns {Date} JSTでのDateオブジェクト
 */
const toJSTDate = (timestamp) => {
    // タイムスタンプは秒単位で入っていると仮定
    const date = fromUnixTime(timestamp); 
    // Dateオブジェクトはブラウザのローカルタイムゾーンで表示されるため、
    // ここで敢えてJSTに変換する必要はないが、時刻表示の際にJSTとして扱う
    return date; 
};


// ==========================================
// 3. UI切り替えロジック
// ==========================================
// (前回のコードから変更なし)
const sections = {
  graphs: document.getElementById('graph-section'),
  map: document.getElementById('map-section'),
  table: document.getElementById('table-section')
};
const mainButtons = {
  graphs: document.getElementById('btn-graphs'),
  map: document.getElementById('btn-map'),
  table: document.getElementById('btn-table')
};
function switchSection(name) {
  Object.values(sections).forEach(el => el.classList.remove('active'));
  Object.values(mainButtons).forEach(el => el.classList.remove('active'));
  sections[name].classList.add('active');
  mainButtons[name].classList.add('active');
  if (name === 'map') {
    setTimeout(() => map.invalidateSize(), 200);
  }
}
mainButtons.graphs.addEventListener('click', () => switchSection('graphs'));
mainButtons.map.addEventListener('click', () => switchSection('map'));
mainButtons.table.addEventListener('click', () => switchSection('table'));

const subButtons = {
  overview: document.getElementById('sub-btn-overview'),
  panel: document.getElementById('sub-btn-panel'),
  batt: document.getElementById('sub-btn-batt'),
  load: document.getElementById('sub-btn-load')
};
const subViews = {
  overview: document.getElementById('view-overview'),
  panel: document.getElementById('view-panel'),
  batt: document.getElementById('view-batt'),
  load: document.getElementById('view-load')
};
function switchGraphMode(mode) {
  Object.values(subButtons).forEach(btn => btn.classList.remove('active'));
  Object.values(subViews).forEach(view => view.classList.remove('active'));
  subButtons[mode].classList.add('active');
  subViews[mode].classList.add('active');
}
subButtons.overview.addEventListener('click', () => switchGraphMode('overview'));
subButtons.panel.addEventListener('click', () => switchGraphMode('panel'));
subButtons.batt.addEventListener('click', () => switchGraphMode('batt'));
subButtons.load.addEventListener('click', () => switchGraphMode('load'));


// ==========================================
// 4. チャート初期化 (Chart.js)
// ==========================================

/**
 * グラフのX軸（時間軸）設定を取得する関数
 * @returns {object} Chart.jsのscales.x設定
 */
function getTimeAxisConfig() {
    const startOfToday = startOfDay(currentDay);
    const endOfToday = addDays(startOfToday, 1);
    
    return {
        type: 'time',
        time: {
            unit: 'hour',
            displayFormats: { hour: 'HH:mm' }
        },
        // スケールを0時から24時で固定
        min: startOfToday.getTime(),
        max: endOfToday.getTime(),
        title: {
            display: true,
            text: '時刻 (00:00 - 24:00 JST)'
        }
    };
}

// Overview用設定
function createOverviewConfig() {
  return {
    type: 'line',
    data: { datasets: [
        { label: 'V', data: [], borderColor: 'red', yAxisID: 'y' },
        { label: 'I', data: [], borderColor: 'blue', yAxisID: 'y' },
        { label: 'P', data: [], borderColor: 'green', borderDash:[5,5], yAxisID: 'y1' }
    ]},
    options: {
      responsive: true, maintainAspectRatio: false, animation: false,
      parsing: false, // データはオブジェクト {x: time, y: value} 形式で渡す
      plugins: { legend: { position:'top' } },
      scales: {
        x: getTimeAxisConfig(), // ★固定時間軸を設定★
        y: { type:'linear', display:true, position:'left', title:{display:true, text:'V / I'} },
        y1: { type:'linear', display:true, position:'right', title:{display:true, text:'Watts'}, grid:{drawOnChartArea:false} }
      }
    }
  };
}

// Detail用設定
function createDetailConfig(label, color, yTitle='Value') {
  return {
    type: 'line',
    data: { datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color, tension: 0.3 }] },
    options: {
      responsive: true, maintainAspectRatio: false, animation: false,
      parsing: false,
      scales: {
        x: getTimeAxisConfig(), // ★固定時間軸を設定★
        y: { title: { display: true, text: yTitle } }
      }
    }
  };
}


// チャートインスタンス作成
const chartPanelAll = new Chart(document.getElementById('chart-panel-all'), createOverviewConfig());
const chartBattAll  = new Chart(document.getElementById('chart-batt-all'), createOverviewConfig());
const chartLoadAll  = new Chart(document.getElementById('chart-load-all'), createOverviewConfig());

const chartPanelV = new Chart(document.getElementById('chart-panel-v'), createDetailConfig('Voltage', 'red', 'Volts'));
const chartPanelI = new Chart(document.getElementById('chart-panel-i'), createDetailConfig('Current', 'blue', 'Amps'));

const chartBattV = new Chart(document.getElementById('chart-batt-v'), createDetailConfig('Voltage', 'orange', 'Volts'));
const chartBattI = new Chart(document.getElementById('chart-batt-i'), createDetailConfig('Current', 'cyan', 'Amps'));

const chartLoadV = new Chart(document.getElementById('chart-load-v'), createDetailConfig('Voltage', 'purple', 'Volts'));
const chartLoadI = new Chart(document.getElementById('chart-load-i'), createDetailConfig('Current', 'magenta', 'Amps'));


/**
 * グラフをクリアし、新しい日の設定を適用する
 */
function resetCharts() {
    [chartPanelAll, chartBattAll, chartLoadAll, chartPanelV, chartPanelI, chartBattV, chartBattI, chartLoadV, chartLoadI].forEach(chart => {
        chart.data.datasets.forEach(d => d.data = []); // データクリア
        chart.options.scales.x = getTimeAxisConfig(); // 新しい日の設定を適用
        chart.update();
    });
    console.log(`Charts reset for new day: ${format(currentDay, 'yyyy-MM-dd')}`);
}

/**
 * グラフにデータポイントを追加する（X軸は時刻）
 * @param {Chart} chart - Chart.jsインスタンス
 * @param {number} timestampMs - 時刻 (ミリ秒)
 * @param {...number} values - V, I, Pなどの値
 */
function pushDataToChart(chart, timestampMs, ...values) {
    values.forEach((v, i) => {
        if(chart.data.datasets[i]) {
            chart.data.datasets[i].data.push({ x: timestampMs, y: v });
        }
    });
    chart.update();
}


// ==========================================
// 5. マップ初期化
// ==========================================
const map = L.map("map").setView([35.0, 135.0], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OSM" }).addTo(map);
let marker = null;

// ==========================================
// 6. データ受信 & 処理
// ==========================================
onValue(ref(db, "latest"), (snap) => {
  const raw = snap.val();
  if (!raw || !raw.timestamp) return;

  // --- データの入れ替え ---
  const data = {
    panel:   raw.battery || {}, 
    battery: raw.panel   || {}, 
    load:    raw.load    || {},
    GPS:     raw.GPS     || {},
    // Firebaseから得られるtimestampは秒単位と仮定し、ミリ秒に変換
    timestamp: raw.timestamp * 1000 
  };
  
  // JSTでのDateオブジェクトを取得
  const fullDateJST = new Date(data.timestamp); // ブラウザのローカル時刻で解釈されるため、実質JSTとして扱える
  const timeMs = fullDateJST.getTime();
  const timeStr = format(fullDateJST, 'HH:mm:ss');

  // --- 日付のチェックとグラフのリセット ---
  const currentDataDay = startOfDay(fullDateJST);
  if (currentDataDay.getTime() > currentDay.getTime()) {
      // 日付が変わった場合、現在の日の設定を更新し、グラフをリセット
      currentDay = currentDataDay;
      resetCharts();
  } else if (currentDataDay.getTime() < currentDay.getTime()) {
      // 過去日のデータが来た場合は無視するか、処理をスキップ (ここでは単にログを残す)
      console.log("Received data from a past date. Skipping chart update.");
      // return; // 過去データを受け取らない場合はコメント解除
  }


  // 値の取得
  const pv = data.panel.voltage ?? 0, pi = data.panel.current ?? 0, pp = data.panel.power ?? 0;
  const bv = data.battery.voltage ?? 0, bi = data.battery.current ?? 0, bp = data.battery.power ?? 0;
  const lv = data.load.voltage ?? 0, li = data.load.current ?? 0, lp = data.load.power ?? 0;

  // グラフ更新 (X軸にタイムスタンプを渡す)
  pushDataToChart(chartPanelAll, timeMs, pv, pi, pp);
  pushDataToChart(chartBattAll,  timeMs, bv, bi, bp);
  pushDataToChart(chartLoadAll,  timeMs, lv, li, lp);

  pushDataToChart(chartPanelV, timeMs, pv);
  pushDataToChart(chartPanelI, timeMs, pi);
  pushDataToChart(chartBattV,  timeMs, bv);
  pushDataToChart(chartBattI,  timeMs, bi);
  pushDataToChart(chartLoadV,  timeMs, lv);
  pushDataToChart(chartLoadI,  timeMs, li);

  // マップ更新
  if (data.GPS.lat && data.GPS.lng) {
    const pos = [data.GPS.lat, data.GPS.lng];
    const popupContent = `Power: ${pp}W<br>Time: ${timeStr} JST`; // JST表示
    if (!marker) {
      marker = L.marker(pos).addTo(map);
      marker.bindPopup(popupContent).openPopup();
    } else {
      marker.setLatLng(pos).setPopupContent(popupContent);
    }
    map.panTo(pos);
  }

  // ログ保存
  allDataLog.unshift({ dateObj: fullDateJST, timeStr: timeStr, pv, pi, pp, bv, bi, bp, lv, li, lp });
  renderTable();
});

// ==========================================
// 7. テーブル処理
// ==========================================
// (前回のコードから変更なし)
const btnHourly = document.getElementById('btn-toggle-hourly');
btnHourly.addEventListener('click', () => {
  isHourlyMode = !isHourlyMode;
  btnHourly.innerText = isHourlyMode ? "1時間ごとにまとめる (ON)" : "1時間ごとにまとめる (OFF)";
  btnHourly.style.background = isHourlyMode ? "#ff6f61" : "#e0e0e0";
  btnHourly.style.color = isHourlyMode ? "white" : "black";
  renderTable();
});
document.getElementById('date-picker').addEventListener('change', () => renderTable());

function renderTable() {
  const tbody = document.querySelector('#data-table tbody');
  tbody.innerHTML = '';

  const selectedDateStr = document.getElementById('date-picker').value;
  
  // ログのdateObjはブラウザのローカルタイムゾーン（JST）で作成されているため、そのまま比較可能
  const filtered = allDataLog.filter(d => format(d.dateObj, 'yyyy-MM-dd') === selectedDateStr);

  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10">データなし (受信待ち)</td></tr>';
    return;
  }

  if (!isHourlyMode) {
    filtered.forEach(d => {
      tbody.innerHTML += `<tr>
        <td>${d.timeStr}</td>
        <td>${d.pv}</td><td>${d.pi}</td><td>${d.pp}</td>
        <td>${d.bv}</td><td>${d.bi}</td><td>${d.bp}</td>
        <td>${d.lv}</td><td>${d.li}</td><td>${d.lp}</td>
      </tr>`;
    });
  } else {
    const groups = {};
    filtered.forEach(d => {
      const h = d.dateObj.getHours();
      if (!groups[h]) groups[h] = { count:0, pv:0, pi:0, pp:0, bv:0, bi:0, bp:0, lv:0, li:0, lp:0 };
      const g = groups[h];
      g.count++;
      g.pv += Number(d.pv); g.pi += Number(d.pi); g.pp += Number(d.pp);
      g.bv += Number(d.bv); g.bi += Number(d.bi); g.bp += Number(d.bp);
      g.lv += Number(d.lv); g.li += Number(d.li); g.lp += Number(d.lp);
    });

    Object.keys(groups).sort((a,b)=>b-a).forEach(h => {
      const g = groups[h];
      const avg = (val) => (val / g.count).toFixed(2);
      tbody.innerHTML += `<tr class="summary-row">
        <td>${h}:00 - ${h}:59 (n=${g.count})</td>
        <td>${avg(g.pv)}</td><td>${avg(g.pi)}</td><td>${avg(g.pp)}</td>
        <td>${avg(g.bv)}</td><td>${avg(g.bi)}</td><td>${avg(g.bp)}</td>
        <td>${avg(g.lv)}</td><td>${avg(g.li)}</td><td>${avg(g.lp)}</td>
      </tr>`;
    });
  }
}
</script>
</body>
</html>
