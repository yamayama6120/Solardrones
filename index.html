<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Dashboard Pro - Altitude Integrated</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
  header { display: flex; justify-content: center; gap: 15px; background: #1a1a2e; padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
  header button { background: #303050; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; }
  header button.active { background: #ff4757; }

  .section { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
  .section.active { display: block; }
  .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
  
  /* グラフを縦に大きく配置 */
  .chart-box { position: relative; height: 380px; width: 100%; }
  
  #map { width: 100%; height: 600px; border-radius: 15px; }
  .control-panel { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
  table { width: 100%; border-collapse: collapse; background: white; }
  th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
  th { background: #1a1a2e; color: white; }
</style>
</head>
<body>

<header>
  <button id="nav-graphs" class="active" onclick="showTab('graphs')">グラフ表示</button>
  <button id="nav-map" onclick="showTab('map')">GPSマップ表示</button>
  <button id="nav-table" onclick="showTab('table')">過去データ・集計</button>
</header>

<div id="sec-graphs" class="section active">
  <div class="card"><h3>Panel Power (W)</h3><div class="chart-box"><canvas id="rt-p"></canvas></div></div>
  <div class="card"><h3>Battery Power (W)</h3><div class="chart-box"><canvas id="rt-b"></canvas></div></div>
  <div class="card"><h3>Load Power (W)</h3><div class="chart-box"><canvas id="rt-l"></canvas></div></div>
</div>

<div id="sec-map" class="section">
  <div class="card">
    <div id="map"></div>
  </div>
</div>

<div id="sec-table" class="section">
  <div class="control-panel">
    <input type="date" id="h-date">
    <input type="time" id="h-start" value="00:00"> 〜 <input type="time" id="h-end" value="23:59">
    <button onclick="plotHistory()" style="background:#2980b9; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">グラフプロット</button>
    <button onclick="updateTable()" style="background:#7f8c8d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">表示更新</button>
  </div>
  <div class="card" id="hist-card" style="display:none;">
    <h3>履歴プロット</h3><div class="chart-box"><canvas id="hist-chart"></canvas></div>
  </div>
  <div class="card">
    <table>
      <thead><tr><th>Time</th><th>Lat</th><th>Lng</th><th>Alt</th><th>P(W)</th><th>B(W)</th><th>L(W)</th></tr></thead>
      <tbody id="log-body"></tbody>
    </table>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let log = [];
let charts = {};

// グラフ初期化
const createChart = (id, label, color) => new Chart(document.getElementById(id), {
  type: 'line',
  data: { labels: [], datasets: [{ label: label, borderColor: color, data: [], fill: true, backgroundColor: color+'22' }] },
  options: { responsive: true, maintainAspectRatio: false, animation: false }
});

charts.p = createChart('rt-p', 'Panel(W)', '#f1c40f');
charts.b = createChart('rt-b', 'Battery(W)', '#e67e22');
charts.l = createChart('rt-l', 'Load(W)', '#e74c3c');
charts.h = new Chart(document.getElementById('hist-chart'), { type:'line', data:{labels:[], datasets:[{label:'P',borderColor:'#f1c40f',data:[]},{label:'B',borderColor:'#e67e22',data:[]},{label:'L',borderColor:'#e74c3c',data:[]}]}, options:{responsive:true,maintainAspectRatio:false}});

// マップ
const map = L.map('map').setView([35, 135], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker = null;

onValue(ref(db, "latest"), (snap) => {
  const d = snap.val(); if(!d) return;
  const t = new Date().toLocaleTimeString();
  const pp = (d.panel.v * d.panel.c / 1000).toFixed(2);
  const bp = (d.battery.v * d.battery.c / 1000).toFixed(2);
  const lp = (d.load.v * d.load.c / 1000).toFixed(2);

  const update = (c, v) => {
    c.data.labels.push(t); c.data.datasets[0].data.push(v);
    if(c.data.labels.length > 40){ c.data.labels.shift(); c.data.datasets[0].data.shift(); }
    c.update();
  };
  update(charts.p, pp); update(charts.b, bp); update(charts.l, lp);

  if(d.GPS.lat){
    const pos = [d.GPS.lat, d.GPS.lng];
    const popupContent = `<b>Power:</b> ${pp}W<br><b>Alt:</b> ${d.GPS.alt}m`;
    if(!marker) marker = L.marker(pos).addTo(map).bindPopup(popupContent).openPopup();
    else marker.setLatLng(pos).setPopupContent(popupContent);
    map.panTo(pos);
  }
  log.unshift({t, date:new Date().toISOString().split('T')[0], gps:d.GPS, pp, bp, lp});
});

window.showTab = (n) => {
  document.querySelectorAll('.section, header button').forEach(el => el.classList.remove('active'));
  document.getElementById(`sec-${n}`).classList.add('active');
  document.getElementById(`nav-${n}`).classList.add('active');
  if(n === 'map') setTimeout(()=>map.invalidateSize(), 200);
};

window.plotHistory = () => {
  const dt = document.getElementById('h-date').value;
  const filtered = log.filter(d => d.date === dt).reverse();
  document.getElementById('hist-card').style.display = 'block';
  charts.h.data.labels = filtered.map(d => d.t);
  charts.h.data.datasets[0].data = filtered.map(d => d.pp);
  charts.h.data.datasets[1].data = filtered.map(d => d.bp);
  charts.h.data.datasets[2].data = filtered.map(d => d.lp);
  charts.h.update();
};

window.updateTable = () => {
  const dt = document.getElementById('h-date').value;
  const body = document.getElementById('log-body');
  body.innerHTML = log.filter(d => d.date === dt).map(d => `
    <tr>
      <td>${d.t}</td><td>${d.gps.lat?.toFixed(4)}</td><td>${d.gps.lng?.toFixed(4)}</td>
      <td>${d.gps.alt}m</td><td>${d.pp}</td><td>${d.bp}</td><td>${d.lp}</td>
    </tr>
  `).join('');
};
document.getElementById('h-date').valueAsDate = new Date();
</script>
</body>
</html>
