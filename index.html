<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Dashboard - Final Custom</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: 'Arial', sans-serif; margin: 0; background: #f4f6f8; color: #333; }
  header { display: flex; justify-content: center; gap: 15px; background: #1e1e2f; padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
  header button { background: #3b3b5f; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; }
  header button.active { background: #ff6f61; }

  .section { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
  .section.active { display: block; }

  .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
  .chart-container { position: relative; height: 250px; width: 100%; }
  .chart-container-lg { position: relative; height: 350px; width: 100%; }

  /* グリッドレイアウト */
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
  
  .sub-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
  .sub-nav button { background: white; border: 2px solid #3b3b5f; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
  .sub-nav button.active { background: #3b3b5f; color: white; }

  #map-container { height: 600px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  #map { width: 100%; height: 100%; }

  .control-panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  table { width: 100%; border-collapse: collapse; background: white; }
  th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
  th { background: #3b3b5f; color: white; }
</style>
</head>
<body>

<header>
  <button id="btn-graphs" class="active" onclick="showSection('graphs')">グラフ表示</button>
  <button id="btn-map" onclick="showSection('map')">GPSマップ表示</button>
  <button id="btn-table" onclick="showSection('table')">過去データ・集計</button>
</header>

<div id="graph-section" class="section active">
  <div class="sub-nav">
    <button class="sub-nav-btn active" onclick="switchGraphMode('overview')">電力個別 (Power)</button>
    <button class="sub-nav-btn" onclick="switchGraphMode('detail')">V/I 詳細</button>
  </div>

  <div id="view-overview" class="graph-sub-view">
    <div class="grid-3">
      <div class="card"><h3>Panel Power (W)</h3><div class="chart-container"><canvas id="rt-p-pwr"></canvas></div></div>
      <div class="card"><h3>Battery Power (W)</h3><div class="chart-container"><canvas id="rt-b-pwr"></canvas></div></div>
      <div class="card"><h3>Load Power (W)</h3><div class="chart-container"><canvas id="rt-l-pwr"></canvas></div></div>
    </div>
  </div>

  <div id="view-detail" class="graph-sub-view" style="display:none;">
    <div class="grid-3">
      <div class="card"><h3>Panel V/I</h3><div class="chart-container"><canvas id="rt-p-vi"></canvas></div></div>
      <div class="card"><h3>Battery V/I</h3><div class="chart-container"><canvas id="rt-b-vi"></canvas></div></div>
      <div class="card"><h3>Load V/I</h3><div class="chart-container"><canvas id="rt-l-vi"></canvas></div></div>
    </div>
  </div>
</div>

<div id="map-section" class="section">
  <div id="map-container"><div id="map"></div></div>
</div>

<div id="table-section" class="section">
  <div class="control-panel">
    <div><b>日付:</b> <input type="date" id="hist-date"></div>
    <div><b>期間:</b> <input type="time" id="hist-start" value="00:00"> 〜 <input type="time" id="hist-end" value="23:59"></div>
    <button onclick="plotHistory()" style="background:#2980b9; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">グラフプロット</button>
    <button onclick="renderTable()" style="background:#7f8c8d; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">テーブル更新</button>
  </div>

  <div class="card" id="history-plot-area" style="display:none;">
    <h3>指定期間の電力推移 (History Plot)</h3>
    <div class="chart-container-lg"><canvas id="hist-chart"></canvas></div>
  </div>

  <div class="card">
    <table id="data-table">
      <thead>
        <tr><th>Time</th><th>P-Volt</th><th>P-Curr</th><th>B-Volt</th><th>B-Curr</th><th>L-Volt</th><th>L-Curr</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- 変数管理 ---
let allDataLog = [];
let charts = {};
const MAX_RT = 30;

// --- マップ (元のロジックを復元) ---
const map = L.map("map").setView([35.0, 135.0], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OSM" }).addTo(map);
let marker = null;

// --- グラフ初期化 ---
function createLineChart(id, label, color) {
  return new Chart(document.getElementById(id), {
    type: 'line',
    data: { labels: [], datasets: [{ label: label, borderColor: color, data: [], tension: 0.3, fill: false }] },
    options: { responsive: true, maintainAspectRatio: false, animation: false }
  });
}

function createVIChart(id) {
  return new Chart(document.getElementById(id), {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'Volt', borderColor: '#2980b9', data: [], yAxisID: 'y' },
      { label: 'Curr', borderColor: '#27ae60', data: [], yAxisID: 'y1' }
    ]},
    options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y1: { position: 'right', grid: { drawOnChartArea: false } } } }
  });
}

charts.pPwr = createLineChart('rt-p-pwr', 'Panel(W)', '#f1c40f');
charts.bPwr = createLineChart('rt-b-pwr', 'Batt(W)', '#e67e22');
charts.lPwr = createLineChart('rt-l-pwr', 'Load(W)', '#e74c3c');
charts.pVI = createVIChart('rt-p-vi');
charts.bVI = createVIChart('rt-b-vi');
charts.lVI = createVIChart('rt-l-vi');

charts.hist = new Chart(document.getElementById('hist-chart'), {
  type: 'line',
  data: { labels: [], datasets: [
    { label: 'Panel Power', borderColor: '#f1c40f', data: [] },
    { label: 'Battery Power', borderColor: '#e67e22', data: [] },
    { label: 'Load Power', borderColor: '#e74c3c', data: [] }
  ]},
  options: { responsive: true, maintainAspectRatio: false }
});

// --- データ受信メイン ---
onValue(ref(db, "latest"), (snap) => {
  const raw = snap.val(); if (!raw) return;

  // Swap logic (User requested Panel and Battery swap)
  const d = {
    t: new Date().toLocaleTimeString(),
    date: new Date().toISOString().split('T')[0],
    pv: raw.battery?.voltage || 0, pi: raw.battery?.current || 0,
    bv: raw.panel?.voltage || 0, bi: raw.panel?.current || 0,
    lv: raw.load?.voltage || 0, li: raw.load?.current || 0,
    gps: raw.GPS || { lat: 35, lng: 135 }
  };
  const pp = (d.pv * d.pi).toFixed(2);
  const bp = (d.bv * d.bi).toFixed(2);
  const lp = (d.lv * d.li).toFixed(2);

  // 1. リアルタイムグラフ更新
  const update = (chart, label, vals) => {
    chart.data.labels.push(label);
    vals.forEach((v, i) => chart.data.datasets[i].data.push(v));
    if (chart.data.labels.length > MAX_RT) { chart.data.labels.shift(); chart.data.datasets.forEach(ds => ds.data.shift()); }
    chart.update();
  };
  update(charts.pPwr, d.t, [pp]);
  update(charts.bPwr, d.t, [bp]);
  update(charts.lPwr, d.t, [lp]);
  update(charts.pVI, d.t, [d.pv, d.pi]);
  update(charts.bVI, d.t, [d.bv, d.bi]);
  update(charts.lVI, d.t, [d.lv, d.li]);

  // 2. マップ (元のロジック復元)
  if (d.gps.lat && d.gps.lng) {
    const pos = [d.gps.lat, d.gps.lng];
    if (!marker) {
      marker = L.marker(pos).addTo(map);
      marker.bindPopup(`Power: ${pp}W`).openPopup();
    } else {
      marker.setLatLng(pos).setPopupContent(`Power: ${pp}W`);
    }
    map.panTo(pos);
  }

  // 3. ログ保存
  allDataLog.unshift({ ...d, pp, bp, lp });
});

// --- 履歴プロット (Past Data セクション内) ---
window.plotHistory = () => {
  const date = document.getElementById('hist-date').value;
  const start = document.getElementById('hist-start').value;
  const end = document.getElementById('hist-end').value;

  const filtered = allDataLog.filter(d => d.date === date && d.t >= start && d.t <= end).reverse();
  
  if (filtered.length === 0) { alert("データが見つかりません"); return; }

  document.getElementById('history-plot-area').style.display = 'block';
  charts.hist.data.labels = filtered.map(d => d.t);
  charts.hist.data.datasets[0].data = filtered.map(d => d.pp);
  charts.hist.data.datasets[1].data = filtered.map(d => d.bp);
  charts.hist.data.datasets[2].data = filtered.map(d => d.lp);
  charts.hist.update();
};

// --- その他 UI制御 ---
window.showSection = (name) => {
  document.querySelectorAll('.section, header button').forEach(el => el.classList.remove('active'));
  document.getElementById(`${name}-section`).classList.add('active');
  document.getElementById(`btn-${name}`).classList.add('active');
  if (name === 'map') setTimeout(() => map.invalidateSize(), 200);
};

window.switchGraphMode = (mode) => {
  document.querySelectorAll('.graph-sub-view').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.sub-nav-btn').forEach(el => el.classList.remove('active'));
  document.getElementById(`view-${mode}`).style.display = 'block';
  event.target.classList.add('active');
};

window.renderTable = () => {
  const tbody = document.querySelector('#data-table tbody');
  const date = document.getElementById('hist-date').value;
  const data = allDataLog.filter(d => d.date === date);
  tbody.innerHTML = data.map(d => `<tr><td>${d.t}</td><td>${d.pv}</td><td>${d.pi}</td><td>${d.bv}</td><td>${d.bi}</td><td>${d.lv}</td><td>${d.li}</td></tr>`).join('');
};

document.getElementById('hist-date').valueAsDate = new Date();
</script>
</body>
</html>
