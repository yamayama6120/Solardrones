<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Dashboard Ultimate V2</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* ===== CSS設定 ===== */
  body { font-family: 'Arial', sans-serif; margin: 0; background: #f4f6f8; color: #333; }

  /* メインヘッダー */
  header { display: flex; justify-content: center; gap: 15px; background: #1e1e2f; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  header button.main-nav { background: #3b3b5f; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-size: 16px; transition: 0.3s; font-weight: bold; }
  header button.main-nav:hover { background: #5c5c8f; transform: translateY(-2px); }
  header button.main-nav.active { background: #ff6f61; box-shadow: 0 0 10px rgba(255,111,97,0.5); }

  /* セクション共通 */
  .section { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.5s; }
  .section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* --- グラフセクション用スタイル --- */
  .sub-nav-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
  .sub-nav-btn { background: white; border: 2px solid #3b3b5f; color: #3b3b5f; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
  .sub-nav-btn:hover { background: #eef; }
  .sub-nav-btn.active { background: #3b3b5f; color: white; }

  .graph-view { display: none; }
  .graph-view.active { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; }
  
  /* カードデザイン（縦並びに対応するため幅を拡大） */
  .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); width: 95%; margin-bottom: 20px; }
  .card h3 { margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; color: #1e1e2f; text-align: center; }
  
  /* グラフキャンバスのサイズ制御（大きく表示） */
  .chart-container-lg { position: relative; height: 400px; width: 100%; }

  /* --- マップ --- */
  #map-container { height: 600px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  #map { width: 100%; height: 100%; border-radius: 8px; }

  /* --- テーブル --- */
  .table-controls { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .btn-download { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
  .btn-download:hover { background: #218838; }
  
  #table-wrapper { background: white; border-radius: 12px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; min-width: 900px; }
  th, td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
  th { background: #3b3b5f; color: white; white-space: nowrap; }
  tr:nth-child(even) { background: #f9f9f9; }
  .summary-row { background: #e3f2fd !important; font-weight: bold; }
</style>
</head>
<body>

<header>
  <button id="btn-graphs" class="main-nav active">グラフ表示</button>
  <button id="btn-map" class="main-nav">GPSマップ表示</button>
  <button id="btn-table" class="main-nav">過去データ・集計</button>
</header>

<div id="graph-section" class="section active">
  <div class="sub-nav-container">
    <button class="sub-nav-btn active" onclick="switchGraphMode('overview')">全体 (Overview)</button>
    <button class="sub-nav-btn" onclick="switchGraphMode('panel')">PANEL 詳細</button>
    <button class="sub-nav-btn" onclick="switchGraphMode('batt')">BATTERY 詳細</button>
    <button class="sub-nav-btn" onclick="switchGraphMode('load')">LOAD 詳細</button>
  </div>

  <div id="view-overview" class="graph-view active">
    <div class="card">
      <h3>Panel (Solar) Overview</h3> 
      <div class="chart-container-lg"><canvas id="chart-panel-all"></canvas></div>
    </div>
    <div class="card">
      <h3>Battery Overview</h3> 
      <div class="chart-container-lg"><canvas id="chart-batt-all"></canvas></div>
    </div>
    <div class="card">
      <h3>Load Overview</h3>
      <div class="chart-container-lg"><canvas id="chart-load-all"></canvas></div>
    </div>
  </div>

  <div id="view-panel" class="graph-view">
    <div class="card">
      <h3>Panel Voltage (V)</h3> <div class="chart-container-lg"><canvas id="chart-panel-v"></canvas></div>
    </div>
    <div class="card">
      <h3>Panel Current (I)</h3> <div class="chart-container-lg"><canvas id="chart-panel-i"></canvas></div>
    </div>
  </div>

  <div id="view-batt" class="graph-view">
    <div class="card">
      <h3>Battery Voltage (V)</h3> <div class="chart-container-lg"><canvas id="chart-batt-v"></canvas></div>
    </div>
    <div class="card">
      <h3>Battery Current (I)</h3> <div class="chart-container-lg"><canvas id="chart-batt-i"></canvas></div>
    </div>
  </div>

  <div id="view-load" class="graph-view">
    <div class="card">
      <h3>Load Voltage (V)</h3> <div class="chart-container-lg"><canvas id="chart-load-v"></canvas></div>
    </div>
    <div class="card">
      <h3>Load Current (I)</h3> <div class="chart-container-lg"><canvas id="chart-load-i"></canvas></div>
    </div>
  </div>
</div>

<div id="map-section" class="section">
  <div id="map-container">
    <div id="map"></div>
  </div>
</div>

<div id="table-section" class="section">
  <div class="table-controls">
    <div>
      <label><b>日付を選択:</b></label>
      <input type="date" id="date-picker">
    </div>
    <div>
      <label><b>集計モード:</b></label>
      <select id="aggregation-select" style="padding: 5px;">
        <option value="raw">生データ (Raw)</option>
        <option value="1min">1分平均</option>
        <option value="1hour">1時間平均</option>
      </select>
    </div>
    <div>
      <button class="btn-download" onclick="downloadCSV()">Excel(CSV) ダウンロード</button>
    </div>
    <div style="margin-left:auto; font-size:0.9em; color:#666;">
      ※受信データはブラウザメモリ内に保存されています
    </div>
  </div>

  <div id="table-wrapper">
    <table id="data-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Panel V</th><th>Panel I</th><th>Panel P</th>
          <th>Batt V</th><th>Batt I</th><th>Batt P</th>
          <th>Load V</th><th>Load I</th><th>Load P</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
// ==========================================
// 0. Firebase Setup
// ==========================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616",
  storageBucket: "dronesgps-f3616.firebasestorage.app",
  messagingSenderId: "1068524436957",
  appId: "1:1068524436957:web:dbd9ec480ced3065314a34",
  measurementId: "G-STNDL06MJT"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ==========================================
// 1. グローバル変数・データ保持
// ==========================================
let allDataLog = []; 
let lastGraphDate = null; // グラフのリセット判定用
let graphUpdateCounter = 0; // グラフ間引き用カウンタ

// 日付ピッカーの初期値を今日に
const today = new Date();
document.getElementById('date-picker').valueAsDate = today;

// ==========================================
// 2. UI切り替えロジック
// ==========================================
const sections = {
  graphs: document.getElementById('graph-section'),
  map: document.getElementById('map-section'),
  table: document.getElementById('table-section')
};
const mainButtons = {
  graphs: document.getElementById('btn-graphs'),
  map: document.getElementById('btn-map'),
  table: document.getElementById('btn-table')
};

window.showSection = (name) => {
  Object.values(sections).forEach(el => el.classList.remove('active'));
  Object.values(mainButtons).forEach(el => el.classList.remove('active'));
  sections[name].classList.add('active');
  mainButtons[name].classList.add('active');
  if (name === 'map') setTimeout(() => map.invalidateSize(), 200);
};
mainButtons.graphs.onclick = () => showSection('graphs');
mainButtons.map.onclick = () => showSection('map');
mainButtons.table.onclick = () => showSection('table');

window.switchGraphMode = (mode) => {
  document.querySelectorAll('.sub-nav-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.graph-view').forEach(div => div.classList.remove('active'));
  document.getElementById(`view-${mode}`).classList.add('active');
};

// テーブル集計セレクトボックス & 日付ピッカー
document.getElementById('aggregation-select').onchange = () => renderTable();
document.getElementById('date-picker').onchange = () => renderTable();

// ==========================================
// 3. チャート初期化 (Chart.js)
// ==========================================
function createConfig(label, color, type='line', yTitle='Value') {
  return {
    type: 'line',
    data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color, tension: 0.1, borderWidth: 2, pointRadius: 0 }] },
    options: {
      responsive: true, maintainAspectRatio: false, animation: false,
      scales: {
        x: { display: true, title: {display:true, text:'Time (00:00 - 24:00)'}, ticks: { maxTicksLimit: 24 } }, // X軸を表示
        y: { title: { display: true, text: yTitle } }
      }
    }
  };
}

function createOverviewConfig() {
  return {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Voltage (V)', data: [], borderColor: '#ff6384', yAxisID: 'y', borderWidth: 2, pointRadius: 0 },
        { label: 'Current (I)', data: [], borderColor: '#36a2eb', yAxisID: 'y', borderWidth: 2, pointRadius: 0 },
        { label: 'Power (W)', data: [], borderColor: '#4bc0c0', borderDash:[5,5], yAxisID: 'y1', borderWidth: 2, pointRadius: 0 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false, animation: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { position:'top' } },
      scales: {
        x: { display: true, ticks: { maxTicksLimit: 24 } },
        y: { type:'linear', display:true, position:'left', title:{display:true, text:'V / I'} },
        y1: { type:'linear', display:true, position:'right', title:{display:true, text:'Watts'}, grid:{drawOnChartArea:false} }
      }
    }
  };
}

// Chart インスタンス
const charts = [];
const chartPanelAll = new Chart(document.getElementById('chart-panel-all'), createOverviewConfig()); charts.push(chartPanelAll);
const chartBattAll  = new Chart(document.getElementById('chart-batt-all'), createOverviewConfig()); charts.push(chartBattAll);
const chartLoadAll  = new Chart(document.getElementById('chart-load-all'), createOverviewConfig()); charts.push(chartLoadAll);

const chartPanelV = new Chart(document.getElementById('chart-panel-v'), createConfig('Voltage', 'red', 'line', 'Volts')); charts.push(chartPanelV);
const chartPanelI = new Chart(document.getElementById('chart-panel-i'), createConfig('Current', 'blue', 'line', 'Amps')); charts.push(chartPanelI);
const chartBattV = new Chart(document.getElementById('chart-batt-v'), createConfig('Voltage', 'orange', 'line', 'Volts')); charts.push(chartBattV);
const chartBattI = new Chart(document.getElementById('chart-batt-i'), createConfig('Current', 'cyan', 'line', 'Amps')); charts.push(chartBattI);
const chartLoadV = new Chart(document.getElementById('chart-load-v'), createConfig('Voltage', 'purple', 'line', 'Volts')); charts.push(chartLoadV);
const chartLoadI = new Chart(document.getElementById('chart-load-i'), createConfig('Current', 'magenta', 'line', 'Amps')); charts.push(chartLoadI);

// グラフ更新関数（一日ごとにリセット機能付き）
function updateCharts(timeLabel, currentDateStr, pv, pi, pp, bv, bi, bp, lv, li, lp) {
  // 日付が変わったらリセット
  if (lastGraphDate !== currentDateStr) {
    charts.forEach(chart => {
      chart.data.labels = [];
      chart.data.datasets.forEach(ds => ds.data = []);
      chart.update();
    });
    lastGraphDate = currentDateStr;
  }

  // データ追加（Overview）
  chartPanelAll.data.labels.push(timeLabel);
  chartPanelAll.data.datasets[0].data.push(pv);
  chartPanelAll.data.datasets[1].data.push(pi);
  chartPanelAll.data.datasets[2].data.push(pp);

  chartBattAll.data.labels.push(timeLabel);
  chartBattAll.data.datasets[0].data.push(bv);
  chartBattAll.data.datasets[1].data.push(bi);
  chartBattAll.data.datasets[2].data.push(bp);

  chartLoadAll.data.labels.push(timeLabel);
  chartLoadAll.data.datasets[0].data.push(lv);
  chartLoadAll.data.datasets[1].data.push(li);
  chartLoadAll.data.datasets[2].data.push(lp);

  // データ追加（詳細）
  [chartPanelV, chartPanelI, chartBattV, chartBattI, chartLoadV, chartLoadI].forEach(c => c.data.labels.push(timeLabel));
  chartPanelV.data.datasets[0].data.push(pv);
  chartPanelI.data.datasets[0].data.push(pi);
  chartBattV.data.datasets[0].data.push(bv);
  chartBattI.data.datasets[0].data.push(bi);
  chartLoadV.data.datasets[0].data.push(lv);
  chartLoadI.data.datasets[0].data.push(li);

  // 全チャート更新
  charts.forEach(c => c.update());
}

// ==========================================
// 4. マップ初期化
// ==========================================
const map = L.map("map").setView([35.0, 135.0], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OSM" }).addTo(map);
let marker = null;

// ==========================================
// 5. データ受信メインロジック
// ==========================================
onValue(ref(db, "latest"), (snap) => {
  const raw = snap.val();
  if (!raw) return;

  // PanelとBatteryの入れ替え
  const data = {
    panel:   raw.battery || {},  
    battery: raw.panel   || {},  
    load:    raw.load    || {},
    GPS:     raw.GPS     || {},
    timestamp: raw.timestamp
  };

  const now = new Date();
  const timeStr = now.toLocaleTimeString('ja-JP', { hour12: false }); // HH:MM:SS
  const dateStr = now.toLocaleDateString('ja-JP'); // YYYY/MM/DD

  const pv = parseFloat(data.panel.voltage || 0);
  const pi = parseFloat(data.panel.current || 0);
  const pp = parseFloat(data.panel.power || 0);
  
  const bv = parseFloat(data.battery.voltage || 0);
  const bi = parseFloat(data.battery.current || 0);
  const bp = parseFloat(data.battery.power || 0);
  
  const lv = parseFloat(data.load.voltage || 0);
  const li = parseFloat(data.load.current || 0);
  const lp = parseFloat(data.load.power || 0);

  // 1. グラフ更新 (負荷軽減のため5回に1回だけ描画に追加するなど、間引き処理)
  // ここではシンプルに毎回更新しますが、データ量が多すぎると重くなるため、
  // 実運用では「5秒に1回だけグラフに追加」などの処理が推奨されます。
  graphUpdateCounter++;
  if (graphUpdateCounter % 5 === 0) { // 5回受信ごとに1回プロット(約5秒毎)
    updateCharts(timeStr, dateStr, pv, pi, pp, bv, bi, bp, lv, li, lp);
  }

  // 2. マップ更新
  if (data.GPS.lat && data.GPS.lng) {
    const pos = [data.GPS.lat, data.GPS.lng];
    if (!marker) {
      marker = L.marker(pos).addTo(map);
      marker.bindPopup(`Power: ${pp}W`).openPopup();
    } else {
      marker.setLatLng(pos).setPopupContent(`Power: ${pp}W`);
    }
    map.panTo(pos);
  }

  // 3. データ履歴保存 (全データ保存)
  allDataLog.unshift({
    dateObj: now,
    dateStr: dateStr, // YYYY/MM/DD
    timeStr: timeStr, // HH:MM:SS
    pv, pi, pp, bv, bi, bp, lv, li, lp
  });
  
  renderTable();
});

// ==========================================
// 6. テーブル描画 & 集計 & CSVダウンロード
// ==========================================
function getFilteredData() {
  const selectedDateStr = document.getElementById('date-picker').value; // YYYY-MM-DD
  // 日付文字列の形式を合わせるための簡易変換
  const targetDate = new Date(selectedDateStr).toLocaleDateString('ja-JP');
  
  // 日付でフィルタリング
  return allDataLog.filter(d => d.dateStr === targetDate);
}

function aggregateData(data, mode) {
  if (mode === 'raw') return data;

  const groups = {};
  data.forEach(d => {
    let key;
    if (mode === '1min') {
      // "HH:MM" をキーにする
      key = d.timeStr.substring(0, 5); 
    } else { // 1hour
      // "HH" (Hour) をキーにする
      key = d.dateObj.getHours();
    }

    if (!groups[key]) {
      groups[key] = { count:0, pv:0, pi:0, pp:0, bv:0, bi:0, bp:0, lv:0, li:0, lp:0, startTime: key };
    }
    const g = groups[key];
    g.count++;
    g.pv += d.pv; g.pi += d.pi; g.pp += d.pp;
    g.bv += d.bv; g.bi += d.bi; g.bp += d.bp;
    g.lv += d.lv; g.li += d.li; g.lp += d.lp;
  });

  // 平均計算して配列に戻す
  const result = Object.keys(groups).sort().reverse().map(k => {
    const g = groups[k];
    const avg = (val) => parseFloat((val / g.count).toFixed(2));
    let timeLabel = k;
    if (mode === '1hour') timeLabel = `${k}:00 - ${k}:59`;
    
    return {
      timeStr: timeLabel,
      pv: avg(g.pv), pi: avg(g.pi), pp: avg(g.pp),
      bv: avg(g.bv), bi: avg(g.bi), bp: avg(g.bp),
      lv: avg(g.lv), li: avg(g.li), lp: avg(g.lp),
      isSummary: true,
      count: g.count
    };
  });
  return result;
}

window.renderTable = () => {
  const tbody = document.querySelector('#data-table tbody');
  tbody.innerHTML = '';

  const mode = document.getElementById('aggregation-select').value;
  const rawData = getFilteredData();
  
  if (rawData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10">データなし (受信待ち)</td></tr>';
    return;
  }

  const displayData = aggregateData(rawData, mode);

  displayData.forEach(d => {
    const timeDisplay = d.isSummary ? `${d.timeStr} (n=${d.count})` : d.timeStr;
    const rowClass = d.isSummary ? 'summary-row' : '';
    
    const row = `<tr class="${rowClass}">
      <td>${timeDisplay}</td>
      <td>${d.pv}</td><td>${d.pi}</td><td>${d.pp}</td>
      <td>${d.bv}</td><td>${d.bi}</td><td>${d.bp}</td>
      <td>${d.lv}</td><td>${d.li}</td><td>${d.lp}</td>
    </tr>`;
    tbody.innerHTML += row;
  });
};

// CSVダウンロード機能
window.downloadCSV = () => {
  const mode = document.getElementById('aggregation-select').value;
  const rawData = getFilteredData();
  
  if (rawData.length === 0) {
    alert("ダウンロードするデータがありません");
    return;
  }

  const dataToExport = aggregateData(rawData, mode);
  
  // CSVヘッダー
  let csvContent = "Time,Panel V,Panel I,Panel P,Batt V,Batt I,Batt P,Load V,Load I,Load P\n";

  dataToExport.forEach(d => {
    const row = [
      d.timeStr,
      d.pv, d.pi, d.pp,
      d.bv, d.bi, d.bp,
      d.lv, d.li, d.lp
    ].join(",");
    csvContent += row + "\n";
  });

  // BOM付与 (Excelで文字化けしないように)
  const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
  const blob = new Blob([bom, csvContent], { type: "text/csv;charset=utf-8;" });
  
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  const dateStr = document.getElementById('date-picker').value;
  
  link.setAttribute("href", url);
  link.setAttribute("download", `drone_data_${dateStr}_${mode}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};
</script>
</body>
</html>
