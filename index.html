<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Dashboard Pro - Full Analysis v2</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; margin: 0; background: #f0f2f5; color: #333; }
  header { display: flex; justify-content: center; gap: 15px; background: #1a1a2e; padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
  header button { background: #303050; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; }
  header button.active { background: #ff4757; }

  .section { display: none; padding: 20px; max-width: 1300px; margin: 0 auto; }
  .section.active { display: block; }
  .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
  
  .sub-nav { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
  .sub-nav button { background: #eee; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
  .sub-nav button.active { background: #1a1a2e; color: white; }

  .chart-box { position: relative; height: 350px; width: 100%; }
  .control-panel { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; }
  
  .table-wrapper { overflow-x: auto; max-height: 500px; }
  table { width: 100%; border-collapse: collapse; min-width: 1000px; }
  th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; font-size: 13px; }
  th { background: #1a1a2e; color: white; position: sticky; top: 0; }
  .col-p { background: rgba(241, 196, 15, 0.05); }
  .col-b { background: rgba(230, 126, 34, 0.05); }
  .col-l { background: rgba(231, 76, 60, 0.05); }
</style>
</head>
<body>

<header>
  <button id="nav-graphs" class="active" onclick="showTab('graphs')">リアルタイム</button>
  <button id="nav-map" onclick="showTab('map')">GPSマップ</button>
  <button id="nav-table" onclick="showTab('table')">過去データ解析</button>
</header>

<div id="sec-graphs" class="section active">
  <div class="sub-nav">
    <button id="btn-mode-w" class="active" onclick="setGraphMode('W')">電力 (W)</button>
    <button id="btn-mode-vi" onclick="setGraphMode('VI')">電圧・電流 (V/mA)</button>
  </div>
  <div id="container-w">
    <div class="card"><h3>Panel Power</h3><div class="chart-box"><canvas id="rt-p-w"></canvas></div></div>
    <div class="card"><h3>Battery Power</h3><div class="chart-box"><canvas id="rt-b-w"></canvas></div></div>
    <div class="card"><h3>Load Power</h3><div class="chart-box"><canvas id="rt-l-w"></canvas></div></div>
  </div>
  <div id="container-vi" style="display:none;">
    <div class="card"><h3>Panel V/I</h3><div class="chart-box"><canvas id="rt-p-vi"></canvas></div></div>
    <div class="card"><h3>Battery V/I</h3><div class="chart-box"><canvas id="rt-b-vi"></canvas></div></div>
    <div class="card"><h3>Load V/I</h3><div class="chart-box"><canvas id="rt-l-vi"></canvas></div></div>
  </div>
</div>

<div id="sec-map" class="section">
  <div class="card"><div id="map" style="width:100%; height:600px; border-radius:15px;"></div></div>
</div>

<div id="sec-table" class="section">
  <div class="control-panel">
    <input type="date" id="h-date">
    <select id="h-res">
      <option value="raw">生データ (4秒)</option>
      <option value="1min">1分平均</option>
      <option value="1hour">1時間平均</option>
    </select>
    <select id="h-type" onchange="updateHistoryChart()">
      <option value="W">電力 (W)</option>
      <option value="V">電圧 (V)</option>
      <option value="I">電流 (mA)</option>
    </select>
    <button onclick="processHistory()" style="background:#2980b9; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">解析実行</button>
  </div>

  <div class="card" id="hist-card" style="display:none;">
    <h3 id="hist-title">過去推移グラフ</h3>
    <div class="chart-box"><canvas id="hist-chart"></canvas></div>
  </div>

  <div class="card">
    <h3>詳細データ一覧</h3>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th rowspan="2">時刻</th><th rowspan="2">高度</th>
            <th colspan="2" class="col-p">Panel</th>
            <th colspan="2" class="col-b">Battery</th>
            <th colspan="2" class="col-l">Load</th>
          </tr>
          <tr>
            <th class="col-p">V</th><th class="col-p">mA</th>
            <th class="col-b">V</th><th class="col-b">mA</th>
            <th class="col-l">V</th><th class="col-l">mA</th>
          </tr>
        </thead>
        <tbody id="log-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let rawLog = [];
let processedData = []; // 集計後のデータを保持
let charts = {};

// グラフ初期化 (省略せず記述)
const createWChart = (id, color) => new Chart(document.getElementById(id), {
  type: 'line', data: { labels: [], datasets: [{ label: 'Power(W)', borderColor: color, data: [], fill: true, backgroundColor: color+'22' }] },
  options: { responsive: true, maintainAspectRatio: false, animation: false }
});

const createVIChart = (id) => new Chart(document.getElementById(id), {
  type: 'line', data: { labels: [], datasets: [
    { label: 'Volt(V)', borderColor: '#3498db', data: [], yAxisID: 'yV' },
    { label: 'Curr(mA)', borderColor: '#2ecc71', data: [], yAxisID: 'yA' }
  ]},
  options: { responsive: true, maintainAspectRatio: false, scales: { yA: { position: 'right', grid: { drawOnChartArea: false } } } }
});

charts.pW = createWChart('rt-p-w', '#f1c40f');
charts.bW = createWChart('rt-b-w', '#e67e22');
charts.lW = createWChart('rt-l-w', '#e74c3c');
charts.pVI = createVIChart('rt-p-vi');
charts.bVI = createVIChart('rt-b-vi');
charts.lVI = createVIChart('rt-l-vi');

charts.h = new Chart(document.getElementById('hist-chart'), {
  type:'line', data:{labels:[], datasets:[
    {label:'Panel', borderColor:'#f1c40f', data:[]},
    {label:'Battery', borderColor:'#e67e22', data:[]},
    {label:'Load', borderColor:'#e74c3c', data:[]}
  ]},
  options:{responsive:true,maintainAspectRatio:false}
});

// マップ初期化
const map = L.map('map').setView([35, 135], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker = null;

// Firebase受信設定
onValue(ref(db, "latest"), (snap) => {
  const d = snap.val(); if(!d) return;
  const t = new Date().toLocaleTimeString();
  
  // 計算
  const pp = (d.panel.voltage * d.panel.current_mA / 1000).toFixed(2);
  const bp = (d.battery.voltage * d.battery.current_mA / 1000).toFixed(2);
  const lp = (d.load.voltage * d.load.current_mA / 1000).toFixed(2);

  const pushData = (chart, vals) => {
    chart.data.labels.push(t);
    vals.forEach((v, i) => chart.data.datasets[i].data.push(v));
    if(chart.data.labels.length > 30){ chart.data.labels.shift(); chart.data.datasets.forEach(ds => ds.data.shift()); }
    chart.update();
  };

  pushData(charts.pW, [pp]); pushData(charts.bW, [bp]); pushData(charts.lW, [lp]);
  pushData(charts.pVI, [d.panel.voltage, d.panel.current_mA]);
  pushData(charts.bVI, [d.battery.voltage, d.battery.current_mA]);
  pushData(charts.lVI, [d.load.voltage, d.load.current_mA]);

  if(d.GPS.lat){
    const pos = [d.GPS.lat, d.GPS.lng];
    if(!marker) marker = L.marker(pos).addTo(map).bindPopup(`Alt: ${d.GPS.alt}m`).openPopup();
    else marker.setLatLng(pos).getPopup().setContent(`Alt: ${d.GPS.alt}m`);
    map.panTo(pos);
  }

  // 生データ蓄積
  rawLog.unshift({
    ts: Date.now(),
    date: new Date().toISOString().split('T')[0],
    time: t,
    alt: d.GPS.alt || 0,
    pv: d.panel.voltage, pi: d.panel.current_mA, pp: parseFloat(pp),
    bv: d.battery.voltage, bi: d.battery.current_mA, bp: parseFloat(bp),
    lv: d.load.voltage, li: d.load.current_mA, lp: parseFloat(lp)
  });
});

// タブ切り替え
window.showTab = (n) => {
  document.querySelectorAll('.section, header button').forEach(el => el.classList.remove('active'));
  document.getElementById(`sec-${n}`).classList.add('active');
  document.getElementById(`nav-${n}`).classList.add('active');
  if(n === 'map') setTimeout(()=>map.invalidateSize(), 200);
};

// リアルタイム表示モード切り替え
window.setGraphMode = (m) => {
  document.getElementById('container-w').style.display = m === 'W' ? 'block' : 'none';
  document.getElementById('container-vi').style.display = m === 'VI' ? 'block' : 'none';
  document.getElementById('btn-mode-w').classList.toggle('active', m === 'W');
  document.getElementById('btn-mode-vi').classList.toggle('active', m === 'VI');
};

// 【解析ロジック】 1分・1時間平均に対応し、V/I/Wすべてを計算
window.processHistory = () => {
  const targetDate = document.getElementById('h-date').value;
  const res = document.getElementById('h-res').value;
  let filtered = rawLog.filter(d => d.date === targetDate).reverse();
  
  if (filtered.length === 0) return alert("指定日のデータがありません");

  if (res === 'raw') {
    processedData = filtered;
  } else {
    const interval = res === '1min' ? 60000 : 3600000;
    const groups = {};
    filtered.forEach(d => {
      const key = Math.floor(d.ts / interval) * interval;
      if (!groups[key]) groups[key] = { count:0, alt:0, pv:0, pi:0, pp:0, bv:0, bi:0, bp:0, lv:0, li:0, lp:0 };
      groups[key].count++;
      ['alt','pv','pi','pp','bv','bi','bp','lv','li','lp'].forEach(field => groups[key][field] += d[field]);
    });
    processedData = Object.keys(groups).sort().map(k => {
      const g = groups[k];
      const resObj = { time: new Date(parseInt(k)).toLocaleTimeString() };
      ['alt','pv','pi','pp','bv','bi','bp','lv','li','lp'].forEach(field => resObj[field] = g[field] / g[count]);
      return resObj;
    });
  }
  updateHistoryChart();
  updateHistoryTable();
};

// グラフ表示項目の更新 (W/V/mAの切り替え)
window.updateHistoryChart = () => {
  if (processedData.length === 0) return;
  const type = document.getElementById('h-type').value;
  const suffix = type === 'W' ? 'p' : type.toLowerCase(); // pp, pv, pi などに対応
  
  charts.h.data.labels = processedData.map(d => d.time || d.time);
  charts.h.data.datasets[0].data = processedData.map(d => d['p' + suffix]);
  charts.h.data.datasets[1].data = processedData.map(d => d['b' + suffix]);
  charts.h.data.datasets[2].data = processedData.map(d => d['l' + suffix]);
  
  document.getElementById('hist-title').innerText = `過去推移グラフ - ${document.getElementById('h-type').selectedOptions[0].text}`;
  document.getElementById('hist-card').style.display = 'block';
  charts.h.update();
};

// テーブル表示の更新
function updateHistoryTable() {
  const body = document.getElementById('log-body');
  body.innerHTML = processedData.map(d => `
    <tr>
      <td>${d.time}</td><td>${d.alt.toFixed(1)}m</td>
      <td class="col-p">${d.pv.toFixed(2)}V</td><td class="col-p">${d.pi.toFixed(0)}</td>
      <td class="col-b">${d.bv.toFixed(2)}V</td><td class="col-b">${d.bi.toFixed(0)}</td>
      <td class="col-l">${d.lv.toFixed(2)}V</td><td class="col-l">${d.li.toFixed(0)}</td>
    </tr>
  `).join('');
}

document.getElementById('h-date').valueAsDate = new Date();
</script>
</body>
</html>
