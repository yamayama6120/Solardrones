<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Dashboard - Integrated</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* cSS.txt のスタイルを反映  */
  body { margin: 0; font-family: Arial, sans-serif; }
  h1 { text-align: center; padding: 10px; background: #222; color: #fff; margin: 0; }
  
  #container { display: flex; } /* 横並びレイアウト  */
  
  #map { width: 70%; height: 90vh; } /* 地図は70%  */
  
  #side { 
    width: 30%; /* サイドバーは30%  */
    padding: 10px; 
    overflow-y: auto; 
    background: #f5f5f5; /* 背景色 [cite: 7] */
  }

  .data-box { 
    background: white; 
    padding: 10px; 
    border-radius: 5px; 
    margin-bottom: 15px; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
  }
  
  h2, h3 { margin-top: 0; margin-bottom: 5px; font-size: 1.1em; }
  .val { font-weight: bold; color: #ff4757; }

  #chart-wrap { margin-top: 20px; }
  canvas { width: 100% !important; height: 180px !important; margin-bottom: 10px; }
</style>
</head>
<body>

<h1>Drone Monitor</h1>

<div id="container">
  <div id="map"></div>

  <div id="side">
    <div class="data-box">
      <h2>Current GPS</h2>
      <p>Time: <span id="time" class="val">N/A</span></p> <p>Lat: <span id="lat" class="val">N/A</span></p> <p>Lng: <span id="lng" class="val">N/A</span></p> <p>Alt: <span id="alt" class="val">N/A</span> m</p> </div>

    <div id="chart-wrap">
      <h3>Power Statistics</h3>
      <canvas id="pChart"></canvas>
      <canvas id="bChart"></canvas>
      <canvas id="lChart"></canvas>
    </div>
    
    <button onclick="exportCSV()" style="width:100%; padding:10px; cursor:pointer;">CSV Export</button>
  </div>
</div>

<script type="module">
// APPJS.txt に基づく Firebase v9 接続 [cite: 1, 2, 3]
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// APPJS.txt の完全な設定 [cite: 2]
const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616",
  storageBucket: "dronesgps-f3616.appspot.com",
  messagingSenderId: "1068524436957",
  appId: "1:1068524436957:web:dbd9ec480ced3065314a34",
  measurementId: "G-STNDL06MJT"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const gpsRef = ref(db, "gps"); // APPJS.txt の監視パス 

let logData = [];

// 地図の初期化
const map = L.map('map').setView([35.68, 139.76], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const marker = L.marker([0, 0]).addTo(map);
const path = L.polyline([], {color: 'red'}).addTo(map);

// グラフの初期化
const createChart = (id, label, color) => new Chart(document.getElementById(id), {
  type: 'line',
  data: { labels: [], datasets: [{ label, data: [], borderColor: color, fill: false, tension: 0.1 }] },
  options: { responsive: true, animation: false }
});
const cp = createChart('pChart', 'Panel (W)', '#fbc02d');
const cb = createChart('bChart', 'Battery (W)', '#9c27b0');
const cl = createChart('lChart', 'Load (W)', '#4caf50');

// APPJS.txt のロジックに基づくデータ受信 
onValue(gpsRef, (snapshot) => {
  const data = snapshot.val() || {};
  console.log("Received:", data);

  // HTML 要素へ反映 
  const lat = data.lat ?? 0;
  const lng = data.lng ?? 0;
  const alt = data.alt ?? 0;
  const time = data.time ?? new Date().toLocaleTimeString();

  document.getElementById("lat").textContent = lat;
  document.getElementById("lng").textContent = lng;
  document.getElementById("alt").textContent = alt;
  document.getElementById("time").textContent = time;

  // 電力計算 (データがある場合)
  const pw = data.panel ? (data.panel.voltage * data.panel.current_mA / 1000) : 0;
  const bw = data.battery ? (data.battery.voltage * data.battery.current_mA / 1000) : 0;
  const lw = data.load ? (data.load.voltage * data.load.current_mA / 1000) : 0;

  // ログ保存
  logData.push({ time, lat, lng, alt, pw, bw, lw });

  // グラフ更新
  const updateChart = (chart, val) => {
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(val);
    if(chart.data.labels.length > 20) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
    chart.update();
  };
  updateChart(cp, pw); updateChart(cb, bw); updateChart(cl, lw);

  // 地図更新
  const pos = [lat, lng];
  if(lat !== 0) {
    marker.setLatLng(pos);
    path.addLatLng(pos);
    map.panTo(pos);
  }
});

// CSV出力
window.exportCSV = () => {
  let csv = "\uFEFFTime,Lat,Lng,Alt,PanelW,BattW,LoadW\n";
  logData.forEach(d => {
    csv += `${d.time},${d.lat},${d.lng},${d.alt},${d.pw},${d.bw},${d.lw}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "drone_data.csv";
  a.click();
};
</script>
</body>
</html>
