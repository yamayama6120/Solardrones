<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Drone Dashboard Pro - Fixed</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: sans-serif; margin: 0; background: #f4f7f6; color: #333; }
  header { display: flex; justify-content: center; gap: 10px; background: #2c3e50; padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
  header button { background: #34495e; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
  header button.active { background: #3498db; }

  .section { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
  .section.active { display: block; }
  .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
  
  /* テーブルのシンプル化 */
  .table-wrapper { overflow-x: auto; border: 1px solid #ddd; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
  th { background: #f8f9fa; font-weight: bold; }
  
  .control-panel { margin-bottom: 15px; display: flex; gap: 10px; }
  #map { height: 500px; width: 100%; border-radius: 8px; }
  canvas { max-height: 400px; }
</style>
</head>
<body>

<header>
  <button id="nav-graphs" class="active" onclick="showTab('graphs')">リアルタイム</button>
  <button id="nav-map" onclick="showTab('map')">GPSマップ</button>
  <button id="nav-table" onclick="showTab('table')">データログ・CSV</button>
</header>

<div id="sec-graphs" class="section active">
  <div class="card">
    <h3>電力監視 (W)</h3>
    <canvas id="rtChart"></canvas>
  </div>
</div>

<div id="sec-map" class="section">
  <div class="card">
    <div id="map"></div>
  </div>
</div>

<div id="sec-table" class="section">
  <div class="card">
    <div class="control-panel">
      <input type="date" id="h-date">
      <select id="h-res">
        <option value="raw">生データ</option>
        <option value="1min">1分平均</option>
      </select>
      <button onclick="processHistory()">解析</button>
      <button onclick="downloadCSV()">CSV出力</button>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>時刻</th><th>緯度</th><th>経度</th><th>高度</th>
            <th>P-Watt</th><th>B-Watt</th><th>L-Watt</th>
          </tr>
        </thead>
        <tbody id="log-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBq9omBu6A-Le7lEjQAlsvqtv8Mqa8tl-c",
  authDomain: "dronesgps-f3616.firebaseapp.com",
  databaseURL: "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dronesgps-f3616"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- グローバル変数 ---
let rawLog = [];
let processedData = [];
let map, marker, pathLine;
let chart;

// --- 1. グラフの初期化 ---
const ctx = document.getElementById('rtChart').getContext('2d');
chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            { label: 'Panel', data: [], borderColor: '#f1c40f', fill: false },
            { label: 'Battery', data: [], borderColor: '#e67e22', fill: false },
            { label: 'Load', data: [], borderColor: '#e74c3c', fill: false }
        ]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
});

// --- 2. 地図の初期化 ---
map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
marker = L.marker([0, 0]).addTo(map);
pathLine = L.polyline([], {color: 'blue'}).addTo(map);

// --- 3. Firebase リアルタイム受信 ---
onValue(ref(db, "latest"), (snap) => {
  const d = snap.val(); if(!d) return;
  const t = new Date();
  const timeStr = t.toLocaleTimeString();

  // 電力計算 (P = V * I)
  const pw = (d.panel.voltage * d.panel.current_mA / 1000);
  const bw = (d.battery.voltage * d.battery.current_mA / 1000);
  const lw = (d.load.voltage * d.load.current_mA / 1000);

  // データ蓄積
  const entry = {
    ts: t.getTime(), date: t.toISOString().split('T')[0], time: timeStr,
    lat: d.GPS.lat, lng: d.GPS.lng, alt: d.GPS.alt,
    pv: d.panel.voltage, pi: d.panel.current_mA, pp: pw,
    bv: d.battery.voltage, bi: d.battery.current_mA, bp: bw,
    lv: d.load.voltage, li: d.load.current_mA, lp: lw
  };
  rawLog.push(entry);

  // グラフ更新 (最新20件)
  chart.data.labels.push(timeStr);
  chart.data.datasets[0].data.push(pw);
  chart.data.datasets[1].data.push(bw);
  chart.data.datasets[2].data.push(lw);
  if(chart.data.labels.length > 20) {
    chart.data.labels.shift();
    chart.data.datasets.forEach(ds => ds.data.shift());
  }
  chart.update('none');

  // 地図更新
  const pos = [d.GPS.lat, d.GPS.lng];
  marker.setLatLng(pos);
  pathLine.addLatLng(pos);
  if(rawLog.length === 1) map.setView(pos, 16); // 初回のみズーム
});

// --- 4. 解析・表示・CSV (簡略化版) ---
window.processHistory = () => {
  const targetDate = document.getElementById('h-date').value;
  processedData = rawLog.filter(d => d.date === targetDate);
  
  const body = document.getElementById('log-body');
  body.innerHTML = processedData.map(d => `
    <tr>
      <td>${d.time}</td><td>${d.lat.toFixed(5)}</td><td>${d.lng.toFixed(5)}</td><td>${d.alt}m</td>
      <td>${d.pp.toFixed(2)}</td><td>${d.bp.toFixed(2)}</td><td>${d.lp.toFixed(2)}</td>
    </tr>
  `).join('');
};

window.downloadCSV = () => {
  if (processedData.length === 0) return alert("データを解析してください");
  let csv = "\uFEFF時刻,緯度,経度,高度,Panel(W),Battery(W),Load(W)\n";
  csv += processedData.map(d => `${d.time},${d.lat},${d.lng},${d.alt},${d.pp},${d.bp},${d.lp}`).join("\n");
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "drone_data.csv"; a.click();
};

window.showTab = (n) => {
  document.querySelectorAll('.section, header button').forEach(el => el.classList.remove('active'));
  document.getElementById(`sec-${n}`).classList.add('active');
  document.getElementById(`nav-${n}`).classList.add('active');
  if(n === 'map') map.invalidateSize(); // 地図のズレ防止
};

document.getElementById('h-date').valueAsDate = new Date();
</script>
</body>
</html>
