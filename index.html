<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Drone Telemetry Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>SOLARDRONES</h1>

<div id="latest">
    <h2>最新データ</h2>
    <pre id="latestData">読み込み中...</pre>
</div>

<div id="map">
    <h2>GPS 位置</h2>
    <iframe
        id="gmap"
        width="100%"
        height="400"
        frameborder="0"
        style="border:0"
        allowfullscreen
        loading="lazy">
    </iframe>
</div>

<div id="history">
    <h2>履歴（最新 20 件）</h2>
    <pre id="historyData">読み込み中...</pre>
</div>

<script>
const baseURL = "https://dronesgps-f3616-default-rtdb.asia-southeast1.firebasedatabase.app";

// 最新データ取得
async function loadLatest() {
    const res = await fetch(`${baseURL}/realtime/latest.json`);
    const data = await res.json();
    document.getElementById("latestData").textContent = JSON.stringify(data, null, 2);

    if (data && data.GPS) {
        updateMap(data.GPS.lat, data.GPS.lng);
    }
}

// Google Map 更新
function updateMap(lat, lng) {
    if (lat === 0 && lng === 0) return;

    const url =
        `https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed`;

    document.getElementById("gmap").src = url;
}

// 履歴取得（最新20件）
async function loadHistory() {
    const res = await fetch(`${baseURL}/realtime/history.json`);
    const data = await res.json();

    if (!data) {
        document.getElementById("historyData").textContent = "履歴なし";
        return;
    }

    const entries = Object.entries(data)
        .sort((a, b) => Number(b[0]) - Number(a[0]))
        .slice(0, 20);

    document.getElementById("historyData").textContent =
        JSON.stringify(Object.fromEntries(entries), null, 2);
}

// 1秒ごとに更新
setInterval(() => {
    loadLatest();
    loadHistory();
}, 1000);

loadLatest();
loadHistory();
</script>

</body>
</html>
